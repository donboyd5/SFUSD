---
title: "OPEB analysis"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook: 
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    number_sections: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

# note that eval=TRUE unless set to FALSE
# to have a chunk's output show in the html file, set include=TRUE in the chunk's options

knitr::opts_chunk$set(eval=TRUE, include=FALSE, echo=FALSE, rows.print=20)
options(width = 150)
```

```{r libraries}
library(tidyverse)
options(tibble.print_max = 80, tibble.print_min = 80) # if more than nn rows, print 60 - enough for states
library(readxl)
library(scales)
library(lubridate)

library(btools)

# tables
library(knitr)
library(kableExtra)
library(DT)
library(gt)

library(maps)
# https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html
library(usmap)
library(gridExtra)
library(RcppRoll)
library(ggrepel)
library(ggbreak)
library(patchwork)
library(RColorBrewer)

library(fredr)

```

```{r constants}
fred_apikey <- "a5e1199baac333154cbffcba3b263c28"
fredr_set_key(fred_apikey)

dsacs <- r"(E:\data\CA_sacs/)"
dsacs_all <- paste0(dsacs, "data/allyears/")

dj90 <- r"(E:\data\CA_j90/)"
dj90_all <- paste0(dj90, "data/allyears/")

#.. graph theme items ----
legend_none <- theme(legend.position = "None")
legend_notitle <- theme(legend.title = element_blank())
caption_left <- theme(plot.caption = element_text(hjust = 0))

#.. source notes ----
sacs_source <- "California Department of Education SACS financial data."


```

```{r logical_expressions}
sfusd <- expression(ccode==38 & dcode==68478)
```

# Marc Joffe's OPEB data

```{r joffe}
mjfn <- "OPEB Study Data 2021-02-18.xlsx"

mj1 <- read_excel(here::here("data", mjfn), sheet="OPEB Study Data")
# glimpse(mj1)
# summary(mj1)

mj2 <- mj1 %>%
  select(-...10) %>%
  rename(stabbr=state,
         penrev=`pension/revenue`,
         opebrev=`opeb/revenue`)
# summary(mj2)
# count(mj2, stabbr)

mjsd <- mj2 %>%
  filter(str_detect(name, coll("school", ignore_case = TRUE)))


```

## Large California, Nevada, and Oregon school districts in 2019: pensions and OPEB as % of revenue

SFUSD has 7th highest OPEB liability as % of total revenue, among large school districts in California, Nevada, and Oregon (defined as those that have at least \$100 million in revenue).

```{r mj_largesd, include=TRUE}
mjsd %>%
  filter(stabbr %in% c("CA", "NV", "OR"), total_revenues >= 100e6) %>%
  arrange(desc(opebrev)) %>%
  select(-c(year, opeb_liabilities_elsewhere)) %>%
  datatable(caption="California, Nevada, and Oregon school districts in 2019 with total revenues >= $100m. Source: Marc Joffe",
            options=list(warn.size=FALSE,
                         pageLength = 20)) %>%
  formatCurrency(
    columns=c("pension_debt", "opeb_debt", "total_revenues"),
    currency = "",
    digits=0,
    interval = 3, 
    mark = ",") %>%
  formatPercentage(
    columns = c("penrev", "opebrev"),
    digits=1)

```

# SACS financial data

```{r load_sacs}
system.time(all_sacs <- readRDS(paste0(dsacs_all, "all_sacs.rds")))  # 30 secs
sacs_gfcurrent <- readRDS(file=paste0(dsacs_all, "sacs_gfcurrent.rds"))
leas <- readRDS(file=paste0(dsacs_all, "leas.rds"))  # local education agencies -- for k12ada

# str_detect(dname, coll("county", ignore_case = TRUE)
# Alameda 1 · Napa 28 · Santa Clara 43 · Contra Costa 7 · San Francisco 38 · Solano 48 · Marin 21 · San Mateo 41 · Sonoma 49
baycodes <- c(1, 28, 43, 7, 38, 48, 21, 41, 49)
counties <- leas %>% 
  filter(year==2020, dtype=="CO OFFICE") %>%
  select(ccode, dcode, dname) %>%
  mutate(coname=str_extract(dname, ".+?(?= County)"),
         bayarea=ccode %in% baycodes)
counties
# (?= County) means look before " County"
# .+? means get everything

counties %>% filter(bayarea)


```

## SFUSD Health, pension, and OPEB benefits as % of general fund

```{r shares, include=TRUE, fig.width=10, fig.height=6.5}
pdata <- sacs_gfcurrent %>%
  filter(eval(sfusd)) %>%
  select(year, currentadj, gfopebretired, gfopebactives, ercpenadj, health) %>%
  pivot_longer(-c(year, currentadj)) %>%
  mutate(share=value / currentadj,
         name=factor(name,
                     levels=c("health", "ercpenadj", "gfopebactives", "gfopebretired"),
                     labels=c("employee health", "pensions", "opeb-actives", "opeb-retirees"))) %>%
  arrange(name)

p <- pdata %>%
  ggplot(aes(year, share, color=name)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name=NULL) +
  scale_y_continuous(name="% share", labels=percent, breaks=seq(0, 1, .025), limits = c(0, NA)) +
  labs(caption=paste0("Source: ", sacs_source)) + 
  ggtitle("SFUSD health, pension, and OPEB expenditures as % of current education expense",
          subtitle="General fund only. Current expenses adjusted to include OPEB payments. Current expenses and pension payments adjusted to remove state payments to TRS on behalf of districts.") +
  theme_bw() +
  theme(plot.caption = element_text(hjust = 0, face="italic")) +
  legend_notitle
p

ggsave(plot=p, filename=here::here("results", "benefit_shares.png"), width=10, height=6.5, units="in")
write_csv(pdata, here::here("results", "benefit_shares_data.csv"))

```

## SFUSD real per-pupil current educational spending on benefits and other items

```{r gdppi_save, eval=FALSE}
# isolate this so abd save it we don't keep rerunning it

# Gross domestic product (chain-type price index)
# FRED https://fred.stlouisfed.org/series/A191RG3A086NBEA
price <- fredr("A191RG3A086NBEA", frequency = "a")
gdppi <- price %>%
  rename(gdppi=value) %>%
  mutate(year=year(date),
         igdppi=gdppi[year==2020] / gdppi) %>%
  select(year, gdppi, igdppi)
saveRDS(gdppi, here::here("data", "gdppi.rds"))


```


```{r get_gdppi}
gdppi <- readRDS(here::here("data", "gdppi.rds"))

```


```{r rxpp}
names(sacs_gfcurrent)
xpp <- sacs_gfcurrent %>%
  filter(eval(sfusd)) %>%
  left_join(leas %>% 
              filter(eval(sfusd)) %>%
              select(year, ccode, dcode, k12ada), 
            by = c("ccode", "dcode", "year")) %>%
  left_join(gdppi %>% select(year, igdppi), by="year") %>%
  mutate(retben=gfopebretired + ercpenadj,
         salaries=certsals + classsals) %>%  
  pivot_longer(-c(year, ccode, dcode, dname, k12ada, igdppi)) %>%
  mutate(xpp=value / k12ada,  # expenditures per pupil
         rxpp=xpp * igdppi)

```


### Plot over time
```{r rpp_plot, include=TRUE}
# names(sacs_gfcurrent)
capt <- "Note: retirement benefits include OPEB payments for retirees, and exclude state contributions to CalSTRS on behalf of districts"

p <- xpp %>%
  filter(name %in% c("service", "retben", "salaries", "health")) %>%
  ggplot(aes(year, rxpp, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(name="2020 $ per pupil", breaks=seq(0, 10e3, 2e3), labels=comma, limits=c(0, NA)) +
  scale_x_continuous(name=NULL) +
  ggtitle("Expenditures per pupil, 2020 dollars",
          subtitle = "Salaries, services, retirement benefits (pension + OPEB), and employee health") +
  labs(caption=str_wrap(capt, 80)) + 
  theme_bw() +
  caption_left +
  legend_notitle
p

```

### Table of real per pupil general fund spending at key points in time
```{r include=TRUE}
# count(xpp, name)
# names <- c("currentadj", "health", "salaries", "gfopeb", "ercpenadj", "books")
tabdata <- xpp %>%
  select(year, name, rxpp) %>%
  filter(year %in% seq(2000, 2020, 5),
         name %in% names) %>%
  pivot_wider(names_from = name, values_from = rxpp, values_fill = 0) %>%
  mutate(other=currentadj - rowSums(across(-c(year, currentadj)))) %>%
  pivot_longer(-year) %>%
  pivot_wider(names_from = year, names_prefix = "y") %>%
  mutate(change=y2020 - y2015,
         pchange=change / y2020) %>%
  mutate(group=ifelse(name=="other", 2, 1)) %>%
  arrange(group, -y2020) %>%
  select(-group)

tabdata %>%
  gt() %>%
  tab_header(
      title = "Real per-pupil general fund expenditures in SFUSD",
      subtitle = "2020 dollars (GDP price index)"
    ) %>%
    fmt_number(
      columns = c(starts_with("y"), change),
      decimals = 0,
      suffixing = FALSE
    ) %>%
    fmt_percent(
      columns = "pchange",
      decimals = 1
    )

```


## General fund OPEB spending

```{r opebdf}

opebdf <- sacs_gfcurrent %>%
  select(year, ccode, dcode, dname, currentadj, gfopeb, gfopebretired, gfopebactives,
         o3701, o3702, o3751, o3752) %>%
  left_join(leas %>% select(year, ccode, dcode, dtypef, k12ada), 
            by = c("year", "ccode", "dcode")) %>%
  # get county name
  left_join(counties %>% select(ccode, coname), by=c("ccode")) %>%
  left_join(gdppi %>% select(year, igdppi), by="year") %>%
  # NOTE: using TOTAL opeb below, not just retired or actives
  mutate(bayarea=ccode %in% baycodes,
         share=gfopeb / currentadj,
         opebpp=gfopeb / k12ada,
         teacher=o3701 + o3751,
         classified=o3702 + o3752,
         teacherpp=teacher / k12ada,
         classifiedpp=classified / k12ada,
         retiredpp=gfopebretired / k12ada,
         activespp=gfopebactives / k12ada,
         sfusd=eval(sfusd),
         ropebpp=opebpp * igdppi)
# ns(sacs_gfcurrent)
```


A few quick exploratory graphs

```{r}
# find oddities
opebdf %>%
  filter(year==2020) %>%
  select(ccode, dcode, dname, k12ada, gfopebretired, gfopebactives, gfopeb, opebpp, share) %>%
  arrange(desc(gfopeb))

# drop ccode 19	dcode 40139	Pupil Transportation Co-Op JPA, which is 100%

# a lot of the oddities have k12ada <= 100
opebdf %>%
  filter(year==2020, k12ada > 0) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(desc(opebpp))

opebdf %>%
  filter(year==2020, k12ada >= 1000) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(gfopeb)

opebdf %>%
  filter(year==2020, k12ada >= 100) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(desc(opebpp))

opebdf %>%
  filter(year==2020) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(desc(k12ada))

opebdf %>%
  filter(eval(sfusd)) %>%
  write_csv(here::here("data", "sfusdopeb.csv"))


# drops <- expression((ccode==19 & dcode==40139))

```



```{r opeb_share, include=FALSE}

opebdf %>%
  filter(year==2020, k12ada >= 1000, opebpp >= 0) %>%
  ggplot(aes(k12ada, share, colour=sfusd)) +
  geom_point() +
  scale_x_log10(labels=comma) +
  scale_y_continuous(labels=percent) +
  # scale_y_log10(labels=percent) +
  ggtitle("OPEB (retired + actives) as % of adjusted current expenditures, General Fund, 2020",
          subtitle="By district size (attendance), log10 scale") +
  labs(caption="Districts with at least 1,000 students and nonnegative opeb.") +
  caption_left
   

```


```{r opeb_ada_plot, include=TRUE}
# relative to attendance
# opeb_pup1kp %>%
#   filter(eval(lausd)) %>%
#   ggplot(aes(year, opebpp)) +
#   geom_line() +
#   geom_point()

sizecut <- 1000

# outlier high
out <- expression(ccode==49 & dcode==75390) # Healdsburg Unified
lausd <- expression(ccode==19 & dcode==64733)

pdata1 <- opebdf %>%
  filter(year==2020, k12ada >= sizecut, opebpp >= 0) %>%  # drop negative opebpp
  filter(!(is.na(k12ada) | is.na(opebpp)))

labs <- pdata1 %>%
  filter(eval(sfusd) |
           eval(lausd) |
           eval(out) |
           k12ada >= 50e3) %>%
  select(ccode, dcode, dname, k12ada, opebpp) %>%
  mutate(special=TRUE,
         label=case_when(eval(sfusd) ~ "SFUSD",
                         eval(lausd) ~ "LAUSD",
                         TRUE ~ str_wrap(dname, 10)))

pdata <- pdata1 %>%
  left_join(labs %>% select(ccode, dcode, special, label), by=c("ccode", "dcode")) %>%
  mutate(colour=case_when(eval(sfusd) ~ 1, 
                         !is.na(label) ~ 2,
                         TRUE ~ 3),
         colour=as.factor(colour),
         label=ifelse(is.na(label), "", label))

# median(pdata$opebpp[pdata$k12ada >= 30e3])
sfusd_points <- pdata %>% filter(eval(sfusd))
# sfusd_points$opebpp

brks <- c(seq(0, 1200, 300), sfusd_points$opebpp, median(pdata$opebpp)) %>% sort
brks
labs <- dollar(brks, accuracy=1)
labs[brks==median(pdata$opebpp)] <- "median"
labs

subt <- paste0("By district size (attendance).", " Includes districts with at least ",
               comma(sizecut), " students (n=", nrow(pdata), ").")
subt
capt <- paste0("Source: ", sacs_source)

p <- pdata %>%
  ggplot(aes(k12ada, opebpp, colour=colour)) +
  geom_point(size=1.0) +
  geom_text(aes(label=label), hjust=0, size=2, nudge_x = .025, nudge_y=10) +
  geom_hline(yintercept = sfusd_points$opebpp, size=0.5, linetype="dotted") +
  geom_hline(yintercept = median(pdata$opebpp), size=0.25, linetype="dotted") +
  scale_colour_manual(values=c("blue", "darkgreen", "grey50")) +
  scale_x_log10(name="Attendance (log scale)", labels=comma, limits=c(1000, 1e6)) +
  scale_y_continuous(name="OPEB expenditures per pupil", limits=c(0, NA), breaks=brks, labels = labs) +
  theme_bw() +
  ggtitle("California school district OPEB expenditures per pupil, General Fund, 2020",
          subtitle=subt) +
  labs(caption=capt) +
  caption_left +
  legend_none
    
p
ggsave(plot=p, filename=here::here("results", "opebpp.png"), width=10, height=6.5, units="in")
write_csv(pdata, here::here("results", "opebpp.csv"))

```
Medians by district size

```{r opeb_ada_medians, include=TRUE}

gcuts <- c(0, 1e3, 5e3, seq(10e3, 50e3, 10e3), 100e3, Inf)
cut(gcuts, gcuts)[-1]
cutlabs <- paste0(#str_pad(gcuts[1:(length(gcuts)-1)] / 1000, 3, "left", " "),
                  gcuts[1:(length(gcuts)-1)] / 1000,
                  "-",
                  gcuts[2:length(gcuts)] / 1000,
                  # str_pad(gcuts[2:length(gcuts)] / 1000, 3, "left", " "),
                  " thousand")
cutlabs[1] <- "<= 1 thousand"
cutlabs[length(cutlabs)] <- "> 100 thousand (LAUSD)"
cutlabs
cbind(gcuts, cutlabs)


f <- function(value){
  comma(value / 1000, accuracy=1)
}
cutlabs <- tibble(groupnum=1:length(gcuts),
                  cutlb=c(-Inf, gcuts[1:(length(gcuts) - 1)]),
                  cutub=gcuts,
                  group=cut(cutub, gcuts)) %>%
  mutate(cutlabel=case_when(cutub <= 0 ~ "Negative",
                            cutlb == 0 ~ paste0("Up to ", f(cutub)),
                            is.infinite(cutub) ~ paste0("Above ", f(cutlb)),
                            TRUE ~ paste0(">", f(cutlb), "-", f(cutub))),
         cutlabelk=ifelse(cutlb >= 0, paste0(cutlabel, " thousand"), cutlabel),
         cutlabelk=ifelse(is.infinite(cutub), paste0(cutlabelk, " (LAUSD)"), cutlabelk))
cutlabs

tabdata <- opebdf %>%
  filter(year==2020, k12ada > 0, opebpp >= 0) %>%
  mutate(group=cut(k12ada, gcuts),
         glev=as.integer(group)) %>%
  left_join(cutlabs, by="group") %>%
  group_by(glev, cutlb, cutub, group, cutlabelk) %>%
  summarise(n=n(), mdn=median(opebpp), 
            min=min(opebpp), max=max(opebpp), 
            p25=quantile(opebpp, .25), p75=quantile(opebpp, .75),
            p10=quantile(opebpp, .10), p90=quantile(opebpp, .90),
            .groups="drop") %>%
  mutate(group=as.character(group)) %>%
  add_row(cutlabelk="SFUSD (included in 50-100 thousand group)", n=1, mdn=sfusd_points$opebpp) %>%
  mutate(sfusd=row_number()==max(row_number()),
         across(c(min, max, p25, p75), ~ ifelse(n==1, NA_real_, .x)))
tabdata

tab <- tabdata %>%
  select(cutlabelk, n, mdn, min, max) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020 by district size"),
      subtitle = ""
    ) %>%
  cols_label(
    cutlabelk=html("District group<br>(# of pupils)"),
    n=html("Number<br>of districts"),
    # mdn=html("OPEB expenditures<br>per pupil<br>(Group median)")
    mdn="Median",
    min="Minimum",
    max="Maximum"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabelk
  ) %>%
  tab_spanner(label="OPEB expenditures per pupil",
              columns = c(mdn, min, max)) %>%
  fmt_number(
    columns = c(n, mdn, min, max),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_currency(
    columns = c(mdn, min, max),
    rows=c(1, nrow(tabdata)),
    decimals = 0
  ) %>%
  fmt_missing(columns=c(mdn, min, max)) %>%
  tab_source_note(paste0("Source: ", sacs_source)) %>%
    tab_row_group(
    rows = 1:(nrow(tabdata) -1 ),
    label=""
  ) %>%
  # hide lines
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "white",
      weight = px(0)
    ),
    location = cells_row_groups()
  )
tab
gtsave(tab, here::here("results", "opebpp_bysize_ptliles.png"))  # , zoom = 1.5, expand = 10)


tab <- tabdata %>%
  select(cutlabelk, n, mdn) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020 by district size"),
      subtitle = ""
    ) %>%
  cols_label(
    cutlabelk=html("District group<br>(# of pupils)"),
    n=html("Number<br>of districts"),
    mdn=html("OPEB expenditures<br>per pupil<br>(Group median)")
  ) %>%
  cols_align(
    align="left",
    columns=cutlabelk
  ) %>%
  fmt_number(
    columns = c(n, mdn),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_currency(
    columns = c(mdn),
    # rows=c(1, nrow(tabdata)),
    decimals = 0
  ) %>%
  fmt_missing(columns=c(mdn)) %>%
  tab_source_note(paste0("Source: ", sacs_source)) %>%
    tab_row_group(
    rows = 1:(nrow(tabdata) -1 ),
    label=""
  ) %>%
  # hide lines
  tab_style(
    style = cell_borders(
      sides = c("bottom"),
      color = "white",
      weight = px(0)
    ),
    location = cells_row_groups()
  )
tab
gtsave(tab, here::here("results", "opebpp_bysize.png"))  # , zoom = 1.5, expand = 10)



```


## OPEB size
```{r include=TRUE}

gcuts <- c(-Inf, 0, 50, 100, 200, 300, 400, 500, 750, Inf)

cutlabs <- tibble(groupnum=1:(length(gcuts) - 1),
                  cutlb=c(gcuts[1:(length(gcuts) - 1)]),
                  cutub=gcuts[-1],
                  group=cut(cutub, gcuts, include.lowest=TRUE)) %>%
  mutate(cutlabel=case_when(cutub == 0 ~ "Zero",
                            is.infinite(cutub) ~ paste0("Above $", f(cutlb)),
                            TRUE ~ paste0(">$", f(cutlb), "-", f(cutub))))
cutlabs
# p25=quantile(opebpp, .25), p75=quantile(opebpp, .75),

tabdata <- opebdf %>%
  filter(year==2020, k12ada > 0, opebpp >= 0) %>%
  filter(k12ada >= 1000) %>%
  mutate(group=cut(opebpp, gcuts, include.lowest=TRUE),
         glev=as.integer(group)) %>%
  left_join(cutlabs, by="group") %>%
  group_by(glev, cutlb, cutub, group, cutlabel) %>%
  summarise(n=n(), 
            mdn=median(opebpp), 
            mdnada=median(k12ada),
            minada=min(k12ada),
            maxada=max(k12ada),
            .groups="drop") %>%
  left_join(opebdf %>%
              filter(year==2020, k12ada > 0, opebpp >= 0) %>%
              select(note=dname, maxada=k12ada), by = "maxada") %>%
  mutate(note=ifelse(cutlb==500, paste0(note, " (SFUSD also is in this group)"), note),
         pctn=n / sum(n),
         cumpctn=cumsum(pctn))
tabdata

tab <- tabdata %>%
  mutate(junk="         ") %>%
  select(cutlabel, n, cumpctn, mdnada, maxada, junk, note) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020 by OPEB expenditure size"),
      subtitle = "Includes districts with at least 1,000 pupils"
    ) %>%
  tab_spanner(label="District size (average daily attendance)",
              columns=contains("ada")) %>%
  cols_label(
    junk="",
    cutlabel=html("District group"),
    n=html("Number<br>of districts"),
    cumpctn=html("Cumulative<br>% of districts"),
    mdnada="Median",
    maxada="Largest",
    note="Name of largest district"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabel
  ) %>%
  fmt_number(
    columns = c(n, mdnada, maxada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_percent(columns = cumpctn, decimals=1) %>%
  tab_source_note(paste0("Source: ", sacs_source)) %>%
  # force space in the junk column (before notes)
  tab_style(
    style = cell_text(whitespace = "pre"),
    locations = cells_body(
      columns = junk
      )
    )

# "normal", "nowrap", "pre", "pre-wrap", "pre-line", and "break-spaces"
gtsave(tab, here::here("results", "opebpp_byopebsize_ptliles.png"))  # , zoom = 1.5, expand = 10)


```

## Percent of districts by OPEB size group
```{r include=TRUE}

gcuts <- c(-Inf, 0, 50, 100, 200, 300, 400, 500, 750, Inf)

f <- function(value){
  comma(value, accuracy=1)
}

cutlabs <- tibble(groupnum=1:(length(gcuts) - 1),
                  cutlb=c(gcuts[1:(length(gcuts) - 1)]),
                  cutub=gcuts[-1],
                  group=cut(cutub, gcuts, include.lowest=TRUE)) %>%
  mutate(cutlabel=case_when(cutub == 0 ~ "Zero",
                            is.infinite(cutub) ~ paste0("Above $", f(cutlb)),
                            TRUE ~ paste0(">$", f(cutlb), "-", f(cutub))))
cutlabs
# p25=quantile(opebpp, .25), p75=quantile(opebpp, .75),

tabdata <- opebdf %>%
  filter(year==2020, k12ada > 0, opebpp >= 0) %>%
  filter(k12ada >= 1000) %>%
  mutate(grandada=median(k12ada),
         group=cut(opebpp, gcuts, include.lowest=TRUE),
         glev=as.integer(group)) %>%
  left_join(cutlabs, by="group") %>%
  group_by(glev, cutlb, cutub, group, cutlabel) %>%
  summarise(n=n(), 
            mdnada=median(k12ada),
            k12ada=sum(k12ada),
            grandada=first(grandada),
            .groups="drop") %>%
  mutate(cumpctn=cumsum(n) / sum(n), 
         cumpctada=cumsum(k12ada) / sum(k12ada)) %>%
  add_row(cutlabel="Total", n=sum(.$n), cumpctn=1, mdnada=.$grandada[1], k12ada=sum(.$k12ada), cumpctada=1) %>%
  select(-grandada)
tabdata

tab <- tabdata %>%
  select(cutlabel, n, cumpctn, mdnada, k12ada, cumpctada) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020"),
      subtitle = "Includes districts with at least 1,000 pupils"
    ) %>%
  tab_spanner(label="Number of districts",
              columns=c(n, cumpctn)) %>%
  tab_spanner(label="Number of pupils (average daily attendance)",
              columns=c(mdnada, k12ada, cumpctada)) %>%
  cols_label(
    cutlabel=html("OPEB expenditure<br>per pupil"),
    n=html("Number"),
    cumpctn=html("Cumulative %"),
    mdnada="Median",
    k12ada="Group total",
    cumpctada="Cumulative %"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabel
  ) %>%
  fmt_number(
    columns = c(n, mdnada, k12ada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_percent(columns = c(cumpctn, cumpctada), decimals=1) %>%
  tab_source_note(paste0("Source: ", sacs_source))

tab

gtsave(tab, here::here("results", "opebpp_byopebsize_v2.png"))  # , zoom = 1.5, expand = 10)


tab <- tabdata %>%
  select(cutlabel, n, cumpctn, k12ada, cumpctada) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020"),
      subtitle = "Includes districts with at least 1,000 pupils"
    ) %>%
  tab_spanner(label="Number of districts",
              columns=c(n, cumpctn)) %>%
  tab_spanner(label="Number of pupils (average daily attendance)",
              columns=c(k12ada, cumpctada)) %>%
  cols_label(
    cutlabel=html("OPEB expenditure<br>per pupil"),
    n=html("Number"),
    cumpctn=html("Cumulative %"),
    k12ada="Group total",
    cumpctada="Cumulative %"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabel
  ) %>%
  fmt_number(
    columns = c(n, k12ada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_percent(columns = c(cumpctn, cumpctada), decimals=1) %>%
  tab_source_note(paste0("Source: ", sacs_source))

tab

gtsave(tab, here::here("results", "opebpp_byopebsize_v3.png"))  # , zoom = 1.5, expand = 10)



```




## Bay Area large districts' general fund OPEB spending over time
```{r bay_unified, fig.height=8, fig.width=8, include=TRUE}
# Alameda · Napa · Santa Clara · Contra Costa · San Francisco · Solano · Marin · San Mateo · Sonoma
n <- 25

baytop <- opebdf %>%
  filter(year==2020, bayarea, dtypef=="unified", opebpp >= 0, k12ada >= 1000) %>%
  select(year, ccode, dcode, coname, dname, dtypef, opebpp, k12ada) %>%
  mutate(k12ada_rank=rank(desc(k12ada)),
         opebpp_rank=rank(desc(opebpp)),
         codist=paste0(coname, ": ", dname))

# get plot data
pdata <- baytop %>%
  filter(k12ada_rank <= 25) %>%
  select(ccode, dcode, codist, dname, k12ada_rank, opebpp_rank) %>%
  left_join(opebdf, by=c("ccode", "dcode")) %>%
  mutate(codist=factor(codist, levels=baytop %>% arrange(opebpp_rank) %>% .$codist))

capt1 <- paste0("Source: ", sacs_source)
capt2 <- "NOTE: Includes payments for retirees plus any trust contributions for actives. Horizontal dotted line marks SFUSD in 2020."
capt <- paste0(capt1, "\n", capt2)
p <- pdata %>%
  ggplot(aes(year, ropebpp)) +
  geom_line(colour="blue", size=.5) +
  geom_point(colour="blue", size=.75) +
  geom_hline(yintercept = baytop %>% 
               filter(eval(sfusd)) %>% 
               .$opebpp, linetype="dotted") +
  theme_bw() +
  facet_wrap(~codist, ncol=5, labeller=label_wrap_gen(width = 25, multi_line = TRUE)) +
  ggtitle(label="General Fund OPEB expenditures per pupil, inflation-adjusted",
          subtitle="25 largest Bay Area unified school districts, by attendance. Districts ordered by 2020 per-pupil OPEB spending.") +
  scale_y_continuous(name="$ per pupil", labels=comma) +
  scale_x_continuous(name=NULL) +
  labs(caption=capt) +
  caption_left
p  

ggsave(plot=p, filename=here::here("results", "bayarea_ropebpp.png"), width=10, height=10, units="in")
write_csv(pdata, here::here("results", "bayarea_ropebpp_data.csv"))


```


# Why are SFUSD costs so high?

## Certificated vs. classified
```{r include=TRUE}
sizecut <- 1000

pdata1 <- opebdf %>%
  filter(k12ada > 0) %>%
  filter(year==2020, k12ada >= sizecut, opebpp >= 0) %>%  # drop negative opebpp
  filter(!(is.na(k12ada) | is.na(opebpp))) %>%
  select(ccode, dcode, coname, dname, bayarea, year, k12ada, opebpp, teacherpp, classifiedpp) %>%
  mutate(across(c(opebpp, teacherpp, classifiedpp), list(i=function(.x) .x / median(.x))))

pdata %>%
  filter(year==2020) %>%
  mutate(tshare=teacherpp / opebpp) %>%
  group_by(sfusd) %>%
  summarise(qtiledf(tshare), .groups="drop")

```




### Teachers and classified

#### SFUSD over time

This is important because if we see that trends for teachers and classified are similar, we will feel better about drawing conclusions based on J-90 data, which are for teachers (certificated employees) only.

```{r tchr_class, include=TRUE}

opeb2 %>%
  filter(eval(sfusd)) %>%
  select(year, teacherpp, classifiedpp, opebpp) %>%
  pivot_longer(-year) %>%
  mutate(name=factor(name, 
                     levels=c("opebpp", "teacherpp", "classifiedpp"),
                     labels=c("total", "teachers", "classified"))) %>%
  ggplot(aes(year, value, colour=name)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name=NULL) +
  scale_y_continuous(name="$ per pupil", limits=c(0, NA)) +
  ggtitle(label="SFUSD nominal general fund OPEB expenditures on retirees, per pupil",
          subtitle="By pre-retirement job category") +
  theme_bw() +
  legend_notitle

```


```{r doc_opeb}

# documentation on selected sacs codes ------------------------------------
#.. 3101–3102 State Teachers’ Retirement System ----
# State Teachers’ Retirement System. Record expenditures to provide personnel
# with retirement benefits under the State Teachers’ Retirement System (STRS).
# This excludes employee contributions. Object 3101 is certificated personnel in
# STRS; Object 3102 includes those individuals who hold classified positions but
# are enrolled in STRS.

#.. 3201–3202 Public Employees’ Retirement System ----
# Public Employees’ Retirement System. Record expenditures to provide personnel
# with retirement benefits under the Public Employees’ Retirement System (PERS).
# This excludes employee contributions, although it does include the employer’s
# payment of an employee’s contribution. Object 3201 indicates those employees
# in certificated positions and enrolled in PERS; Object 3202 indicates
# employees in classified positions and enrolled in PERS.

#.. 3401–3402 Health and Welfare Benefits ----
# Health and Welfare Benefits. Record expenditures made to provide personnel
# with health and welfare insurance benefits. This excludes employee
# contributions but includes health and welfare benefit premiums paid to a
# self-insurance fund. Object 3401 indicates that the benefits cover
# certificated positions; Object 3402 indicates that the benefits cover
# classified positions.


#.. 3701 OPEB, Allocated, certificated positions ----
# Expenditures (1) for retirees and other former employees for current-year
# postemployment benefits other than pensions (OPEB) financed on a pay-as-you-go
# basis; or (2) for the amounts paid to an OPEB plan (administered through a
# qualifying trust) in excess of the current-year actuarially determined service
# cost. A qualifying trust is a trust or an equivalent arrangement that meets
# the criteria in paragraph 4 of GASB Statement 75. Do not include expenditures
# for service costs for active employees; these must be direct-charged using
# objects 3751–3752. Expenditures in objects 3701–3702 must be allocated to all
# activities in proportion to total salaries or total full-time equivalents
# (FTEs) in those activities. Object 3701 relates to certificated positions;
# Object 3702 relates to classified positions.

#.. 3702 OPEB, Allocated, classified positions ----
# same text

#.. 3751 OPEB, Active Employees, certificated positions ----
# Expenditures for the amounts paid to a OPEB plan (administered through a
# qualifying trust) up to the current-year actuarially determined service costs
# for OPEB-eligible active employees. A qualifying trust is a trust or an
# equivalent arrangement that meets the criteria in paragraph 4 of GASB
# Statement 75. Do not include expenditures for retirees and other former
# employees; these must be allocated using objects 3701–3702. Expenditures in
# objects 3751–3752 must be direct-charged on a per-eligible-FTE basis to the
# same resource, goal, and function as the OPEB-eligible active employee’s
# salary. Object 3751 relates to certificated positions; Object 3752 relates to
# classified positions.

#.. 3752 OPEB, Active Employees, classified positions----
# same text

#.. 9664 Total/Net OPEB Liability ----
# The total OPEB liability is the portion of the actuarial present value of
# projected benefit payments that is attributed to past periods of employee
# service, measured in conformity with the requirements of GASB Statement 75.
# For a defined benefit OPEB plan that is not administered through a trust that
# meets the criteria in paragraph 4 of GASB 75 (specified criteria), the total
# OPEB liability is reported. For a defined benefit OPEB plan that is
# administered through a trust that meets the specified criteria, a net OPEB
# liability (that is, the total OPEB liability minus the OPEB plan’s fiduciary
# net position) is reported. The total or net OPEB liability is reported only in
# the LEA’s accrual-basis financial statements.

# I don't bother to include 9664 because almost no districts report it.

```



# J-90 OPEB data

```{r}
opeb_j90 <- readRDS(paste0(dj90_all, "opeb.rds"))

```


## Districts that provide benefits for age 66+ retirees

```{r}
# explore
tmp <- opeb_j90 %>%
  select(year, ccode, dcode, dname, ben_life, ben_stop) %>%
  arrange(year, ccode, dcode) %>%
  group_by(year, ccode, dcode) %>%
  filter(row_number()==1) %>%
  ungroup %>%
  mutate(ben65p=(ben_stop > 65) | (ben_life=="Y"))

tmp %>%
  filter(year==2020) %>%
  group_by(ben_life) %>%
  summarise(stopmin=min(ben_stop), stopmdn=median(ben_stop), stopmax2=max(ben_stop * (ben_stop < 999)))

count(tmp, year, ben65p) %>%
  pivot_wider(names_from = ben65p, values_from = n) %>%
  mutate(pct=`TRUE` / (`TRUE` + `FALSE`))

```


```{r benagem, include=TRUE}
# tabdata <- opeb_j90 %>%
#   filter(plantype=="health") %>%
#   select(year, ccode, dcode, dname, ben_life, ben_stop) %>%
#   arrange(year, ccode, dcode) %>%
#   group_by(year, ccode, dcode) %>%
#   filter(row_number()==1) %>%
#   ungroup %>%
#   mutate(ben65p=(ben_stop > 65) | (ben_life=="Y"),
#          ben65p=ifelse(ben65p, "yes", "no")) %>%
#   group_by(year, ben65p) %>%
#   summarise(n=n(), .groups="drop") %>%
#   pivot_wider(names_from = ben65p, values_from = n) %>%
#   mutate(total=yes + no, pctyes=yes / total)


tabdata <- opeb_j90 %>%
  mutate(ben66p=(ben_stop > 65) | (ben_life=="Y"),
         hasplan=1,
         hasopebfte=opebfte > 0,
         health=plantype=="health",
         healthfte=health & hasopebfte,
         age66p=agecat=="age66p",
         healthplan66p=health & ben66p,
         health66pfte=healthfte & age66p & ben66p) %>%
  group_by(year, ccode, dcode, dname) %>%
  summarise(hasopebfte=sum(hasopebfte) > 0,
            hashealthplan=sum(health, na.rm=TRUE) > 0,
            hashealthplan66p=sum(healthplan66p, na.rm=TRUE) > 0,
            hashealthfte=sum(healthfte, na.rm=TRUE) > 0,
            hashealth66pfte=sum(health66pfte, na.rm=TRUE) > 0, 
            .groups="drop") %>%
  group_by(year) %>%
  summarise(ndists=n(),
            nopebfte=sum(hasopebfte, na.rm=TRUE),
            nhealthplan=sum(hashealthplan, na.rm=TRUE),
            nhealthfte=sum(hashealthfte, na.rm=TRUE),
            nhashealthplan66p=sum(hashealthplan66p, na.rm=TRUE),
            nhealth66pfte=sum(hashealth66pfte, na.rm=TRUE), 
            .groups="drop") %>%
  mutate(pctyes=nhealth66pfte / ndists)

tabdata %>%
  gt() %>%
  tab_header(
      title = "Districts that provide OPEB health benefits beyond age 65",
      subtitle = "ONLY includes districts that provide OPEB health benefits"
    )  %>%
    fmt_number(
      columns = c(no, yes, total),
      decimals = 0,
      suffixing = FALSE
    )  %>%
    fmt_percent(
      columns = pctyes,
      decimals = 1
    ) %>%
  tab_source_note("Source: J-90 data")


```


```{r check}
# tabdata <- opeb_j90 %>%
#   filter(plantype=="health") %>%
#   select(year, ccode, dcode, dname, ben_life, ben_stop) %>%
#   arrange(year, ccode, dcode, planseq, coverage) %>%
#   group_by(year, ccode, dcode) %>%
#   filter(row_number()==1) %>%
#   ungroup %>%
#   mutate(ben65p=(ben_stop > 65) | (ben_life=="Y"),
#          ben65p=ifelse(ben65p, "yes", "no")) %>%
#   group_by(year, ben65p) %>%
#   summarise(n=n(), .groups="drop") %>%
#   pivot_wider(names_from = ben65p, values_from = n) %>%
#   mutate(total=yes + no, pctyes=yes / total)

sf <- opeb_j90 %>%
  filter(eval(sfusd), year==2020) %>%
  mutate(hasopeb=sum(opebfte) > 0) %>%
  filter(plantype=="health", ) %>%
  select(year, ccode, dcode, dname, ben_life, ben_stop) %>%
  arrange(year, ccode, dcode) %>%
  group_by(year, ccode, dcode) %>%
  filter(row_number()==1) %>%
  ungroup %>%
  mutate(ben65p=(ben_stop > 65) | (ben_life=="Y"),
         ben65p=ifelse(ben65p, "yes", "no"))
  count


temp <- opeb_j90 %>%
  filter(plantype=="health") %>%
  select(year, ccode, dcode, dname, ben_life, ben_stop) %>%
  arrange(year, ccode, dcode) %>%
  group_by(year, ccode, dcode) %>%
  filter(row_number()==1) %>%
  ungroup %>%
  mutate(ben65p=(ben_stop > 65) | (ben_life=="Y"),
         ben65p=ifelse(ben65p, "yes", "no"))

temp %>%
  filter(ccode==1, dcode==61119)

temp %>%
  filter(ben65p=="no", year==2020)

file1 <- readRDS(paste0(dj90_all, "tsal_file1.rds")) 
j90dists <- file1 %>%
  group_by(year) %>%
  summarise(n=n())

check <- opeb_j90 %>%
  mutate(ben66p=(ben_stop > 65) | (ben_life=="Y"),
         hasplan=1,
         hasopebfte=opebfte > 0,
         health=plantype=="health",
         healthfte=health & hasopebfte,
         age66p=agecat=="age66p",
         healthplan66p=health & ben66p,
         health66pfte=healthfte & age66p & ben66p) %>%
  group_by(year, ccode, dcode, dname) %>%
  summarise(hasopebfte=sum(hasopebfte) > 0,
            hashealthplan=sum(health, na.rm=TRUE) > 0,
            hashealthplan66p=sum(healthplan66p, na.rm=TRUE) > 0,
            hashealthfte=sum(healthfte, na.rm=TRUE) > 0,
            hashealth66pfte=sum(health66pfte, na.rm=TRUE) > 0, 
            .groups="drop") %>%
  group_by(year) %>%
  summarise(ndists=n(),
            nopebfte=sum(hasopebfte, na.rm=TRUE),
            nhealthplan=sum(hashealthplan, na.rm=TRUE),
            nhealthfte=sum(hashealthfte, na.rm=TRUE),
            nhashealthplan66p=sum(hashealthplan66p, na.rm=TRUE),
            nhealth66pfte=sum(hashealth66pfte, na.rm=TRUE), 
            .groups="drop") %>%
  mutate(pctyes=nhealth66pfte / ndists)



check <- opeb_j90 %>%
  
  filter(plantype=="health", year==2020, 
         # ccode %in% baycodes, 
         # str_detect(dname, coll("unified", ignore_case = TRUE)),
         eval(sfusd)
         ) %>%
  select(year, ccode, dcode, dname, agecat, ben_life, ben_stop, provider,
         planseq, coverage, opebfte, plancost, planercost, planeecost) %>%
  arrange(year, ccode, dcode, agecat, planseq) %>%
  mutate(ben65p=(ben_stop > 65) | (ben_life=="Y"),
         ben65p=ifelse(ben65p, "yes", "no"))

check %>% write_csv("e:/check.csv")

check %>%
  filter(ccode==1, dcode==61127) # no, Albany

check %>%
  filter(ccode==1, dcode==61119) # yes, Alameda


```




## SFUSD by plan type - cost and ftes
```{r plantype, include=TRUE}
rows <- opeb_j90 %>%
  filter(eval(sfusd), year==2020, opebfte > 0) %>%
  group_by(plantype) %>%
  summarise(n=n(), minfte=min(opebfte), maxfte=max(opebfte), sumfte=sum(opebfte), 
            totcost=sum(totcost), totercost=sum(totercost), toteecost=sum(toteecost),
            .groups="drop") %>%
  select(plantype, n, minfte, maxfte, sumfte, toteecost, totercost, totcost)

sumrow <- rows %>%
  summarise(across(c(n, starts_with("tot")),  sum),
            sumfte=max(sumfte),
            minfte=min(minfte),
            maxfte=max(maxfte)) %>%
  mutate(plantype="  Totals/min/max",
         across(starts_with("tot"), ~.x / 1e6))

tabdata <- bind_rows(rows, sumrow) %>%
  mutate(across(starts_with("tot"), ~.x / 1e6), 
         ershare=totercost / totcost)


tabdata %>%
  gt() %>%
  tab_header(
      title = "SFUSD estimated OPEB FTEs and costs, plan year 2020",
      subtitle = "Source: J-90 data"
    )  %>%
  cols_label(
    n=html("Number<br>of plans"),
    minfte="min",
    maxfte="max",
    sumfte="total",
    toteecost=html("Total employee cost"),
    totercost=html("Total employer cost"),
    totcost=html("Total cost"),
    ershare=html("Employer share")
  ) %>%
  tab_spanner(label="# of OPEB FTEs (i.e., retirees)",
              columns=contains("fte")
              ) %>%
  tab_spanner(
    label = "$ millions",
    columns = contains("tot")
    ) %>%
    fmt_number(
      columns = c(n, contains("fte")),
      decimals = 0,
      suffixing = FALSE
    )  %>%
    fmt_number(
      columns = contains("tot"),
      decimals = 2,
      suffixing = FALSE
    ) %>%
    fmt_percent(
      columns = ershare,
      decimals = 1
    )%>%
  tab_footnote(
    footnote = "CAUTION: cost estimates based on J-90 are overestimates but employer share is plausible.",
    locations = cells_column_labels(
      columns = starts_with("tot")
    )
  )


```


# OPEB by age, for SFUSD
```{r include=TRUE}
rows <- opeb_j90 %>%
  filter(eval(sfusd), year==2020, opebfte > 0, plantype=="health") %>%
  group_by(agecat) %>%
  summarise(across(starts_with("tot"), sum))

tabdata <- rows %>%
  bind_rows(rows %>% summarise(across(starts_with("tot"), sum)) %>%
              mutate(agecat="total")) %>%
  pivot_longer(-agecat) %>%
  pivot_wider(names_from = agecat) %>%
  mutate(name=factor(name,
                     levels=c("totercost", "toteecost", "totcost"),
                     labels=c("District", "Retiree", "Total")),
         age66pshare=age66p / total) %>%
  arrange(name)


tabdata %>%
  gt() %>%
  tab_header(
      title = "SFUSD estimated retiree and district costs by age group, plan year 2020",
      subtitle = "Source: J-90 data"
    )  %>%
  cols_label(
    name="Cost paid by:",
    under66=html("Under age 66"),
    age66p=html("Age 66+"),
    total=("Total"),
    age66pshare=html("Age 66+ as %<br>of total cost")
  ) %>%
  fmt_number(
      columns = c(under66, age66p, total),
      decimals = 0,
      suffixing = FALSE
    )  %>%
  fmt_percent(
      columns = age66pshare,
      decimals = 1
    ) %>%
  tab_footnote(
    footnote = "CAUTION: cost estimates based on J-90 may be overestimates.",
    locations = cells_column_labels(
      columns = c(under66, age66p, total)
    )
  )


```




```{r sfusd_health, include=TRUE, fig.width=6, fig.height=6}
opeb_j90 %>%
  filter(eval(sfusd)) %>%
  filter(plantype=="health") %>%
  filter(year==2020) %>%
  mutate(erpct=totercost / sum(totercost),
         lbl=ifelse(erpct > .05, round(erpct, 2), "")) %>%
  ggplot(aes(x=planeecost, y=opebfte, size=erpct, colour=coverage, label=lbl)) +
  geom_point() +
  geom_text(nudge_x = 750, size=3) +
  scale_y_continuous("# of participants", labels = scales::comma) +
  scale_x_continuous("annual cost to the participant", labels=scales::comma) +
  ggtitle("SFUSD OPEB health plans: # of retired participants and per-retiree plan costs in 2020",
          "Size of dot and number represent share of district OPEB health costs.")
```
