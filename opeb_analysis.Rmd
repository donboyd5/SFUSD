---
title: "OPEB analysis"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook: 
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    number_sections: yes
    code_folding: hide
editor_options:
  chunk_output_type: inline
---

# SETUP SECTION
```{r setup, eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

# note that eval=TRUE unless set to FALSE
# to have a chunk's output show in the html file, set include=TRUE in the chunk's options

knitr::opts_chunk$set(eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, rows.print=20)
options(width = 150)
```

```{r libraries}
library(tidyverse)
tprint <- 50  # default tibble print
options(tibble.print_max = tprint, tibble.print_min = tprint) # show up to tprint rows

# tools
library(readxl)
library(lubridate)
library(RColorBrewer)
library(RcppRoll)
library(fredr)
library(btools)

# graphics
library(scales)
library(ggbeeswarm)
library(patchwork)
library(gridExtra)
library(ggrepel)
library(ggbreak)

# tables
library(knitr)
library(kableExtra)
library(DT)
library(gt)

# maps
library(maps)
# https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html
library(usmap)

```

```{r locations}
dsacs <- r"(E:\data\CA_sacs/)"
dsacs_all <- paste0(dsacs, "data/allyears/")

dj90 <- r"(E:\data\CA_j90/)"
dj90_all <- paste0(dj90, "data/allyears/")

```

```{r constants}
#.. api keys ----
fred_apikey <- "a5e1199baac333154cbffcba3b263c28"
fredr_set_key(fred_apikey)

#.. graph theme items ----
legend_none <- theme(legend.position = "None")
legend_notitle <- theme(legend.title = element_blank())
caption_left <- theme(plot.caption = element_text(hjust = 0))

#.. source notes ----
sacs_source <- "California Department of Education SACS financial data"
j90_source <- "California Department of Education J-90 salary and benefits data"

```


# DATA PREPARATION SECTION
## ONETIME dataset creation
```{r ONETIME_gdppi_save, eval=FALSE}
# isolate this so abd save it we don't keep rerunning it

# Gross domestic product (chain-type price index)
# FRED https://fred.stlouisfed.org/series/A191RG3A086NBEA
price <- fredr("A191RG3A086NBEA", frequency = "a")
gdppi <- price %>%
  rename(gdppi=value) %>%
  mutate(year=year(date),
         igdppi=gdppi[year==2020] / gdppi) %>%
  select(year, gdppi, igdppi)
saveRDS(gdppi, here::here("data", "gdppi.rds"))

```

## Load important previously created datasets
```{r load_gdppi}
gdppi <- readRDS(here::here("data", "gdppi.rds"))

```

```{r load_joffe}
mjfn <- "OPEB Study Data 2021-02-18.xlsx"

mj1 <- read_excel(here::here("data", mjfn), sheet="OPEB Study Data")
# glimpse(mj1)
# summary(mj1)

mj2 <- mj1 %>%
  select(-...10) %>%
  rename(stabbr=state,
         penrev=`pension/revenue`,
         opebrev=`opeb/revenue`)
# summary(mj2)
# count(mj2, stabbr)

mjsd <- mj2 %>%
  filter(str_detect(name, coll("school", ignore_case = TRUE)))

```


```{r load_sacs}
#.. all SACS ----
system.time(all_sacs <- readRDS(paste0(dsacs_all, "all_sacs.rds")))  # 30 secs

#.. SACS general fund current expenditures ----
sacs_gfcurrent <- readRDS(file=paste0(dsacs_all, "sacs_gfcurrent.rds"))

#.. SACS Local Education Agencies list ----
leas <- readRDS(file=paste0(dsacs_all, "leas.rds"))  # local education agencies -- for k12ada

# str_detect(dname, coll("county", ignore_case = TRUE)

```


```{r load_j90}
opeb_j90 <- readRDS(paste0(dj90_all, "opeb.rds")) %>%
  rename(k12ada=ada) %>% # to be consistent with SACS naming
  mutate(agecatf=factor(agecat, 
                        levels=c("under66", "age66p"), 
                        labels=c("Under 65", "Age 65+")),
         ben66p=(ben_stop > 65) | (ben_life=="Y"))
count(opeb_j90, agecat, agecatf)
glimpse(opeb_j90)

# tmp <- opeb_j90 %>% filter(is.na(agecat)) # districts that don't provide an explicit health subsidy?

#.. save SFUSD j90 2020 as csv ----
# opeb_j90 %>%
#   filter(eval(sfusd), year==2020) %>%
#   write_csv(here::here("data", "sfusd_j90_2020.csv"))

```


## Definitions for areas and factors
```{r}
#.. sfusd ----
sfusd <- expression(ccode==38 & dcode==68478)

#.. Bay Area counties ----
# Alameda 1 · Napa 28 · Santa Clara 43 · Contra Costa 7 · San Francisco 38
# · Solano 48 · Marin 21 · San Mateo 41 · Sonoma 49
baycodes <- c(1, 28, 43, 7, 38, 48, 21, 41, 49)

#.. top ada (average daily attendance) definition ----
topada <- expression(k12ada >= 1000)  # >= 1000 is my cutoff

```



## Create important data extracts and summaries
```{r}
#.. counties and county offices of education ----
counties <- leas %>% 
  filter(year==2020, dtype=="CO OFFICE") %>%
  select(ccode, dcode, dname) %>%
  mutate(coname=str_extract(dname, ".+?(?= County)"),
         bayarea=ccode %in% baycodes)
counties
# (?= County) means look before " County"
# .+? means get everything

counties %>% filter(bayarea)

```


```{r sacs_rxpp}
#.. SACS real expenditures per pupil ----
names(sacs_gfcurrent)
xpp <- sacs_gfcurrent %>%
  filter(eval(sfusd)) %>%
  left_join(leas %>% 
              filter(eval(sfusd)) %>%
              select(year, ccode, dcode, k12ada), 
            by = c("ccode", "dcode", "year")) %>%
  left_join(gdppi %>% select(year, igdppi), by="year") %>%
  mutate(retben=gfopebretired + ercpenadj,
         salaries=certsals + classsals) %>%  
  pivot_longer(-c(year, ccode, dcode, dname, k12ada, igdppi)) %>%
  mutate(xpp=value / k12ada,  # expenditures per pupil
         rxpp=xpp * igdppi)

```


```{r opebdf}
#.. opebdf: per-pupil SACS data on general fund opeb spending ----
# sacs_gfcurrent created in sacs_summary_files.r
# gfopebretired=o3701 + o3702,
# gfopebactives=o3751 + o3752,
# gfopeb=gfopebretired + gfopebactives

opebdf <- sacs_gfcurrent %>%
  select(year, ccode, dcode, dname, currentadj, gfopeb, gfopebretired, gfopebactives,
         o3701, o3702, o3751, o3752) %>%
  left_join(leas %>% select(year, ccode, dcode, dtypef, k12ada), 
            by = c("year", "ccode", "dcode")) %>%
  # get county name
  left_join(counties %>% select(ccode, coname), by=c("ccode")) %>%
  left_join(gdppi %>% select(year, igdppi), by="year") %>%
  # djb 12/8/2021 replace negative opeb expenditures with zero (perhaps not best solution, but rare) -- YY, FYI
  mutate(across(c(gfopeb, gfopebretired, gfopebactives, o3701, o3702, o3751, o3752),
                ~ ifelse(.x < 0, 0, .x))) %>%
  # NOTE: using TOTAL opeb below, not just retired or actives
  mutate(bayarea=ccode %in% baycodes,
         sfusd=eval(sfusd),
         
         share=gfopeb / currentadj,
         
         # these following amounts are all nominal
         teacher=o3701 + o3751,
         classified=o3702 + o3752,
         opebpp=gfopeb / k12ada,
         
         # nominal per pupil
         teacherpp=teacher / k12ada,
         classifiedpp=classified / k12ada,
         retiredpp=gfopebretired / k12ada,
         activespp=gfopebactives / k12ada,
         
         # real opeb expenditures per pupil
         ropebpp=opebpp * igdppi) 
# ns(sacs_gfcurrent)
```


## Miscellaneous data checks

```{r j90_misc}

# opeb_j90 %>%
#   filter(year==2020) %>%
#   write_csv(here::here("data", "joffe_j90_2020.csv"))
# 
# #.. districts in 2019 not in 2020 (there was a drop in # of districts in 2020) ----
# tmp <- opeb_j90 %>%
#   filter(year %in% 2019:2020) %>%
#   select(year, ccode, dcode, dname, ada) %>%
#   distinct %>%
#   pivot_wider(names_from = year, values_from = ada) %>%
#   filter(is.na(`2020`))
# sum(tmp$`2019`, na.rm=TRUE)
# 
# tmp2 <- opeb_j90 %>%
#   filter(year==2020, plantype=="health") %>%
#   group_by(year, ccode, dcode, dname, agecat) %>%
#   summarise(across(c(opebfte, totercost, toteecost, totcost), sum))
# 
# tmp3 <- tmp2 %>%
#   select(year, ccode, dcode, dname, agecat, value=totercost) %>%
#   pivot_wider(names_from = agecat, values_fill = 0) %>%
#   mutate(agesum=under66 + age66p,
#          pct66p=age66p / agesum) %>%
#   arrange(desc(pct66p))
# 
# 
# tmp3a <- tmp2 %>%
#   select(year, ccode, dcode, dname, agecat, value=opebfte) %>%
#   pivot_wider(names_from = agecat, values_fill = 0) %>%
#   mutate(agesum=under66 + age66p,
#          pct66p=age66p / agesum,
#          ratio=age66p / under66) %>%
#   arrange(desc(pct66p))
# 
# tmp3a %>%
#   mutate(cover=age66p > 0) %>%
#   group_by(cover) %>%
#   summarise(qtiledf(ratio))
# 
# summary(tmp3)
# quantile(tmp3$pct66p, c(0, .05, .1, .25, .5, .75, .8, .85, .9, .95, 1), na.rm=TRUE)
# tmp3 %>%
#   group_by(pct66p==0) %>%
#   summarise(n=n())
```


# ANALYSIS BEGINS HERE

# Marc Joffe's OPEB data

## Large California, Nevada, and Oregon school districts in 2019: pensions and OPEB as % of revenue

SFUSD has 7th highest OPEB liability as % of total revenue, among large school districts in California, Nevada, and Oregon (defined as those that have at least \$100 million in revenue).

```{r mj_largesd, include=TRUE}
mjsd %>%
  filter(stabbr %in% c("CA", "NV", "OR"), total_revenues >= 100e6) %>%
  arrange(desc(opebrev)) %>%
  select(-c(year, opeb_liabilities_elsewhere)) %>%
  datatable(caption="California, Nevada, and Oregon school districts in 2019 with total revenues >= $100m. Source: Marc Joffe",
            options=list(warn.size=FALSE,
                         pageLength = 20)) %>%
  formatCurrency(
    columns=c("pension_debt", "opeb_debt", "total_revenues"),
    currency = "",
    digits=0,
    interval = 3, 
    mark = ",") %>%
  formatPercentage(
    columns = c("penrev", "opebrev"),
    digits=1)

```


# SACS financial data
## NOT USED: SFUSD Health, pension, and OPEB benefits as % of general fund

```{r shares, include=FALSE, fig.width=10, fig.height=6.5}
pdata <- sacs_gfcurrent %>%
  filter(eval(sfusd)) %>%
  select(year, currentadj, gfopebretired, gfopebactives, ercpenadj, health) %>%
  pivot_longer(-c(year, currentadj)) %>%
  mutate(share=value / currentadj,
         name=factor(name,
                     levels=c("health", "ercpenadj", "gfopebactives", "gfopebretired"),
                     labels=c("employee health", "pensions", "opeb-actives", "opeb-retirees"))) %>%
  arrange(name)

p <- pdata %>%
  ggplot(aes(year, share, color=name)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name=NULL) +
  scale_y_continuous(name="% share", labels=percent, breaks=seq(0, 1, .025), limits = c(0, NA)) +
  labs(caption=paste0("Source: ", sacs_source)) + 
  ggtitle("SFUSD health, pension, and OPEB expenditures as % of current education expense",
          subtitle="General fund only. Current expenses adjusted to include OPEB payments. Current expenses and pension payments adjusted to remove state payments to TRS on behalf of districts.") +
  theme_bw() +
  theme(plot.caption = element_text(hjust = 0, face="italic")) +
  legend_notitle
p

# ggsave(plot=p, filename=here::here("results", "benefit_shares.png"), width=10, height=6.5, units="in")
# write_csv(pdata, here::here("results", "benefit_shares_data.csv"))

```

## NOT USED: SFUSD real per-pupil current educational spending on benefits and other items

### Plot over time
```{r rpp_plot, include=FALSE}
# names(sacs_gfcurrent)
# names(xpp)
capt <- "Note: retirement benefits include OPEB payments for retirees, and exclude state contributions to CalSTRS on behalf of districts"

p <- xpp %>%
  filter(name %in% c("service", "retben", "salaries", "health")) %>%
  ggplot(aes(year, rxpp, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(name="2020 $ per pupil", breaks=seq(0, 10e3, 2e3), labels=comma, limits=c(0, NA)) +
  scale_x_continuous(name=NULL) +
  ggtitle("Expenditures per pupil, 2020 dollars",
          subtitle = "Salaries, services, retirement benefits (pension + OPEB), and employee health") +
  labs(caption=str_wrap(capt, 80)) + 
  theme_bw() +
  caption_left +
  legend_notitle
p

```

### NOT USED: Table of real per pupil general fund spending at key points in time
```{r include=FALSE}
# count(xpp, name)
names <- c("currentadj", "health", "salaries", "gfopeb", "ercpenadj", "books")
tabdata <- xpp %>%
  select(year, name, rxpp) %>%
  filter(year %in% seq(2000, 2020, 5),
         name %in% names) %>%
  pivot_wider(names_from = name, values_from = rxpp, values_fill = 0) %>%
  mutate(other=currentadj - rowSums(across(-c(year, currentadj)))) %>%
  pivot_longer(-year) %>%
  pivot_wider(names_from = year, names_prefix = "y") %>%
  mutate(change=y2020 - y2015,
         pchange=change / y2020) %>%
  mutate(group=ifelse(name=="other", 2, 1)) %>%
  arrange(group, -y2020) %>%
  select(-group)

tabdata %>%
  gt() %>%
  tab_header(
      title = "Real per-pupil general fund expenditures in SFUSD",
      subtitle = "2020 dollars (GDP price index)"
    ) %>%
    fmt_number(
      columns = c(starts_with("y"), change),
      decimals = 0,
      suffixing = FALSE
    ) %>%
    fmt_percent(
      columns = "pchange",
      decimals = 1
    )

```

## General fund OPEB spending

## REPORT: OPEB ranking table
```{r opeb_ranks, include=TRUE}

# show top n, median of 25-largest bay area districts, median overall

glimpse(opebdf)
tabdata1 <- opebdf %>%
  filter(year==2020, eval(topada)) %>% 
  # mutate(opebpp=ifelse(opebpp >= 0, opebpp, 0)) %>% # 12/8/2021 no longer needed
  select(year, ccode, dcode, dname, dtypef, sfusd, bayarea, k12ada, opebpp)
summary(tabdata1)
count(tabdata1, dtypef)

ndists <- 20
topn <- tabdata1 %>%
  arrange(desc(opebpp)) %>%
  mutate(rank=row_number()) %>%
  filter(rank <= ndists)

bay25 <- tabdata1 %>%
  filter(bayarea) %>%
  arrange(desc(opebpp)) %>%
  filter(row_number() <= 25)

nonzero <- tabdata1 %>%
  filter(opebpp > 0) %>%
  arrange(desc(opebpp))

tabdata2 <- topn %>%
  bind_rows(bay25 %>% 
              summarise(n=n(),
                        opebpp=median(opebpp),
                        k12ada=median(k12ada)) %>%
              mutate(dname="25 largest Bay Area unified districts"),
            nonzero %>% 
              summarise(n=n(),
                        opebpp=median(opebpp),
                        k12ada=median(k12ada)) %>%
              mutate(dname=paste0(n, " districts with positive OPEB expenditures and at least 1,000 pupils")),
            tabdata1 %>% 
              summarise(n=n(),
                        opebpp=median(opebpp),
                        k12ada=median(k12ada)) %>%
              mutate(dname=paste0("All ", n, " districts with at least 1,000 pupils"))
            )

tabdata <- tabdata2 %>%
  select(rank, dname, k12ada, opebpp)

tab <- tabdata %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020"),
      subtitle = "Only includes districts with at least 1,000 pupils"
    ) %>%
  cols_label(
    rank="",
    dname=html("District or group"),
    k12ada=html("Average daily attendance<br>(for district, or group median)"),
    opebpp=html("Retiree health care<br>expenditures per pupil")
  ) %>%
  cols_align(align="right") %>%
  cols_align(
    align="left",
    columns=dname
  ) %>%
    cols_width(
    c(k12ada, opebpp) ~ px(250),
    dname ~ px(350)
  ) %>%
  fmt_number(
    columns = c(k12ada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_currency(
    columns = c(opebpp),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_missing(columns=rank, missing_text="") %>%
  tab_style(
    style = list(
      # cell_fill(color = "grey90"),
      cell_text(size = px(15), weight = "bold", font = "arial")
      ),
    locations = cells_body(
      # rows = nrow(tabdata))
      rows=str_detect(dname, "San Francisco Unified")
      )
    ) %>%
  tab_source_note(paste0("Source: ", sacs_source))

tab

gtsave(tab,here::here("results", "opebpp_topn_ranking.png"))  # , zoom = 1.5, expand = 10)
write_csv(tabdata, here::here("results", "opebpp_topn_ranking_data.csv"))
  
```

## REPORT: Scatterplot OPEB per pupil vs. attendance, log scale
```{r opeb_ada_plot, include=TRUE}

healdsburg <- expression(ccode==49 & dcode==75390) # Healdsburg Unified -- high outlier
lausd <- expression(ccode==19 & dcode==64733)

pdata1 <- opebdf %>%
  filter(year==2020, eval(topada)) %>%
  filter(!(is.na(k12ada) | is.na(opebpp)))

labs <- pdata1 %>%
  filter(eval(sfusd) |
           eval(lausd) |
           eval(healdsburg) |
           k12ada >= 50e3) %>%
  select(ccode, dcode, dname, k12ada, opebpp) %>%
  mutate(special=TRUE,
         label=case_when(eval(sfusd) ~ "SFUSD",
                         eval(lausd) ~ "LAUSD",
                         TRUE ~ str_wrap(dname, 10)))

pdata <- pdata1 %>%
  left_join(labs %>% select(ccode, dcode, special, label), by=c("ccode", "dcode")) %>%
  mutate(colour=case_when(eval(sfusd) ~ 1, 
                         !is.na(label) ~ 2,
                         TRUE ~ 3),
         colour=as.factor(colour),
         label=ifelse(is.na(label), "", label))

# median(pdata$opebpp[pdata$k12ada >= 30e3])
sfusd_points <- pdata %>% filter(eval(sfusd))
# sfusd_points$opebpp

brks <- c(seq(0, 1200, 300), sfusd_points$opebpp, median(pdata$opebpp)) %>% sort
brks
labs <- dollar(brks, accuracy=1)
labs[brks==median(pdata$opebpp)] <- "median"
labs

subt <- "By district size (attendance). Only includes districts with at least 1,000 students."
subt
capt <- paste0("Source: ", sacs_source)

p <- pdata %>%
  ggplot(aes(k12ada, opebpp, colour=colour)) +
  geom_point(size=1.0) +
  geom_text(aes(label=label), hjust=0, size=2, nudge_x = .025, nudge_y=10) +
  geom_hline(yintercept = sfusd_points$opebpp, size=0.5, linetype="dotted") +
  geom_hline(yintercept = median(pdata$opebpp), size=0.25, linetype="dotted") +
  scale_colour_manual(values=c("blue", "darkgreen", "grey50")) +
  scale_x_log10(name="Attendance (log scale)", labels=comma, limits=c(1000, 1e6)) +
  scale_y_continuous(name="OPEB expenditures per pupil", limits=c(0, NA), breaks=brks, labels = labs) +
  theme_bw() +
  ggtitle("California school district OPEB expenditures per pupil, General Fund, 2020",
          subtitle=subt) +
  labs(caption=capt) +
  caption_left +
  legend_none
    
p
ggsave(plot=p, filename=here::here("results", "opebpp.png"), width=10, height=6.5, units="in")
write_csv(pdata, here::here("results", "opebpp_data.csv"))

```

## REPORT: Table of districts by OPEB size
```{r opebsize_table, include=TRUE}
# define cut points and cut labels
gcuts <- c(-Inf, 0, 50, 100, 200, 300, 400, 500, 750, Inf)

f <- function(value){
  comma(value, accuracy=1)
}

cutlabs <- tibble(groupnum=1:(length(gcuts) - 1),
                  cutlb=c(gcuts[1:(length(gcuts) - 1)]),
                  cutub=gcuts[-1],
                  group=cut(cutub, gcuts, include.lowest=TRUE)) %>%
  mutate(cutlabel=case_when(cutub == 0 ~ "Zero",
                            is.infinite(cutub) ~ paste0("Above $", f(cutlb)),
                            TRUE ~ paste0(">$", f(cutlb), "-", f(cutub))))
cutlabs

tabbase <- opebdf %>%
  filter(year==2020, k12ada > 0, eval(topada)) 

tabdata <- tabbase %>%
  mutate(group=cut(opebpp, gcuts, include.lowest=TRUE),
         glev=as.integer(group)) %>%
  left_join(cutlabs, by="group") %>%
  group_by(glev, cutlb, cutub, group, cutlabel) %>%
  summarise(n=n(), 
            mdn=median(opebpp), 
            mdnada=median(k12ada),
            minada=min(k12ada),
            maxada=max(k12ada),
            .groups="drop") %>%
  left_join(opebdf %>%
              filter(year==2020, k12ada > 0, opebpp >= 0) %>%
              select(note=dname, maxada=k12ada), by = "maxada") %>%
  mutate(note=ifelse(cutlb==500, paste0(note, " (SFUSD also is in this group)"), note),
         pctn=n / sum(n),
         cumpctn=cumsum(pctn))
tabdata

tab <- tabdata %>%
  mutate(junk="         ") %>%
  select(cutlabel, n, cumpctn, mdnada, maxada, junk, note) %>%
  gt() %>%
  tab_header(
      title = "General fund OPEB expenditures per pupil in 2020 by OPEB expenditure size",
      subtitle = "Only includes districts with at least 1,000 pupils"
    ) %>%
  tab_spanner(label="District size (average daily attendance)",
              columns=contains("ada")) %>%
  cols_label(
    junk="",
    cutlabel=html("OPEB expenditures<br> per pupil"),
    n=html("Number<br>of districts"),
    cumpctn=html("Cumulative<br>% of districts"),
    mdnada="Median",
    maxada="Largest",
    note="Name of largest district"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabel
  ) %>%
  fmt_number(
    columns = c(n, mdnada, maxada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_percent(columns = cumpctn, decimals=1) %>%
  tab_source_note(paste0("Source: ", sacs_source)) %>%
  # force space in the junk column (before notes)
  tab_style(
    style = cell_text(whitespace = "pre"),
    locations = cells_body(
      columns = junk
      )
    ) %>%
  tab_style(
    style = list(
      # cell_fill(color = "grey90"),
      cell_text(size = px(15), weight = "bold", font = "arial")
      ),
    locations = cells_body(
      rows=str_detect(note, "SFUSD")
      )
    )

# "normal", "nowrap", "pre", "pre-wrap", "pre-line", and "break-spaces"
tab
gtsave(tab, here::here("results", "opebpp_byopebsize_ptliles.png"))  # , zoom = 1.5, expand = 10)
write_csv(tabdata, here::here("results", "opebpp_byopebsize_ptliles_data.csv"))

```

## REPORT: Line plot Bay Area large districts' general fund OPEB spending over time
```{r bay_unified, fig.height=8, fig.width=8, include=TRUE}
# Alameda · Napa · Santa Clara · Contra Costa · San Francisco · Solano · Marin · San Mateo · Sonoma
topn <- 25

baytop <- opebdf %>%
  filter(year==2020, bayarea, dtypef=="unified", eval(topada)) %>%
  select(year, ccode, dcode, coname, dname, dtypef, opebpp, k12ada) %>%
  mutate(k12ada_rank=rank(desc(k12ada)),
         opebpp_rank=rank(desc(opebpp)),
         codist=paste0(coname, ": ", dname))

# get plot data
pdata <- baytop %>%
  filter(k12ada_rank <= topn) %>%
  select(ccode, dcode, codist, dname, k12ada_rank, opebpp_rank) %>%
  left_join(opebdf, by=c("ccode", "dcode")) %>%
  mutate(codist=factor(codist, levels=baytop %>% arrange(opebpp_rank) %>% .$codist))

capt1 <- paste0("Source: ", sacs_source)
capt2 <- "NOTE: Includes payments for retirees plus any trust contributions for actives. Horizontal dotted line marks SFUSD in 2020."
capt <- paste0(capt1, "\n", capt2)
p <- pdata %>%
  ggplot(aes(year, ropebpp)) +
  geom_line(colour="blue", size=.5) +
  geom_point(colour="blue", size=.75) +
  geom_hline(yintercept = baytop %>% 
               filter(eval(sfusd)) %>% 
               .$opebpp, linetype="dotted") +
  theme_bw() +
  facet_wrap(~codist, ncol=5, labeller=label_wrap_gen(width = 25, multi_line = TRUE)) +
  ggtitle(label="General Fund OPEB expenditures per pupil, inflation-adjusted",
          subtitle="25 largest Bay Area unified school districts, by attendance. Districts ordered by 2020 per-pupil OPEB spending.") +
  scale_y_continuous(name="$ per pupil", labels=comma) +
  scale_x_continuous(name=NULL) +
  labs(caption=capt) +
  caption_left
p  

ggsave(plot=p, filename=here::here("results", "bayarea_ropebpp.png"), width=10, height=10, units="in")
write_csv(pdata, here::here("results", "bayarea_ropebpp_data.csv"))

```

## NOT USED (prob too complicated for audience): Percent of districts by OPEB size group
```{r include=TRUE}

gcuts <- c(-Inf, 0, 50, 100, 200, 300, 400, 500, 750, Inf)

f <- function(value){
  comma(value, accuracy=1)
}

cutlabs <- tibble(groupnum=1:(length(gcuts) - 1),
                  cutlb=c(gcuts[1:(length(gcuts) - 1)]),
                  cutub=gcuts[-1],
                  group=cut(cutub, gcuts, include.lowest=TRUE)) %>%
  mutate(cutlabel=case_when(cutub == 0 ~ "Zero",
                            is.infinite(cutub) ~ paste0("Above $", f(cutlb)),
                            TRUE ~ paste0(">$", f(cutlb), "-", f(cutub))))
cutlabs
# p25=quantile(opebpp, .25), p75=quantile(opebpp, .75),

tabdata <- opebdf %>%
  filter(year==2020, k12ada > 0) %>%
  filter(eval(topada)) %>%
  mutate(grandada=median(k12ada),
         group=cut(opebpp, gcuts, include.lowest=TRUE),
         glev=as.integer(group)) %>%
  left_join(cutlabs, by="group") %>%
  group_by(glev, cutlb, cutub, group, cutlabel) %>%
  summarise(n=n(), 
            mdnada=median(k12ada),
            k12ada=sum(k12ada),
            grandada=first(grandada),
            .groups="drop") %>%
  mutate(cumpctn=cumsum(n) / sum(n), 
         cumpctada=cumsum(k12ada) / sum(k12ada)) %>%
  add_row(cutlabel="Total", n=sum(.$n), cumpctn=1, mdnada=.$grandada[1], k12ada=sum(.$k12ada), cumpctada=1) %>%
  select(-grandada)
tabdata

tab <- tabdata %>%
  select(cutlabel, n, cumpctn, mdnada, k12ada, cumpctada) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020"),
      subtitle = "Only includes districts with at least 1,000 pupils"
    ) %>%
  tab_spanner(label="Number of districts",
              columns=c(n, cumpctn)) %>%
  tab_spanner(label="Number of pupils (average daily attendance)",
              columns=c(mdnada, k12ada, cumpctada)) %>%
  cols_label(
    cutlabel=html("OPEB expenditure<br>per pupil"),
    n=html("Number"),
    cumpctn=html("Cumulative %"),
    mdnada="Median",
    k12ada="Group total",
    cumpctada="Cumulative %"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabel
  ) %>%
  fmt_number(
    columns = c(n, mdnada, k12ada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_percent(columns = c(cumpctn, cumpctada), decimals=1) %>%
  tab_source_note(paste0("Source: ", sacs_source))

tab

# gtsave(tab, here::here("results", "opebpp_byopebsize_v2.png"))  # , zoom = 1.5, expand = 10)


tab <- tabdata %>%
  select(cutlabel, n, cumpctn, k12ada, cumpctada) %>%
  gt() %>%
  tab_header(
      title = paste0("General fund OPEB expenditures per pupil in 2020"),
      subtitle = "Includes districts with at least 1,000 pupils"
    ) %>%
  tab_spanner(label="Number of districts",
              columns=c(n, cumpctn)) %>%
  tab_spanner(label="Number of pupils (average daily attendance)",
              columns=c(k12ada, cumpctada)) %>%
  cols_label(
    cutlabel=html("OPEB expenditure<br>per pupil"),
    n=html("Number"),
    cumpctn=html("Cumulative %"),
    k12ada="Group total",
    cumpctada="Cumulative %"
  ) %>%
  cols_align(
    align="left",
    columns=cutlabel
  ) %>%
  fmt_number(
    columns = c(n, k12ada),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_percent(columns = c(cumpctn, cumpctada), decimals=1) %>%
  tab_source_note(paste0("Source: ", sacs_source))

tab

# gtsave(tab, here::here("results", "opebpp_byopebsize_v3.png"))  # , zoom = 1.5, expand = 10)



```





# NOT USED: Why are SFUSD costs so high?
## Certificated vs. classified
```{r include=FALSE}
sizecut <- 1000

pdata1 <- opebdf %>%
  filter(k12ada > 0) %>%
  filter(year==2020, k12ada >= sizecut, opebpp >= 0) %>%  # drop negative opebpp
  filter(!(is.na(k12ada) | is.na(opebpp))) %>%
  select(ccode, dcode, coname, dname, bayarea, year, k12ada, opebpp, teacherpp, classifiedpp) %>%
  mutate(across(c(opebpp, teacherpp, classifiedpp), list(i=function(.x) .x / median(.x))))

pdata %>%
  filter(year==2020) %>%
  mutate(tshare=teacherpp / opebpp) %>%
  group_by(sfusd) %>%
  summarise(qtiledf(tshare), .groups="drop")

```




### Teachers and classified

#### SFUSD over time

This is important because if we see that trends for teachers and classified are similar, we will feel better about drawing conclusions based on J-90 data, which are for teachers (certificated employees) only.

```{r tchr_class, include=TRUE}

opeb2 %>%
  filter(eval(sfusd)) %>%
  select(year, teacherpp, classifiedpp, opebpp) %>%
  pivot_longer(-year) %>%
  mutate(name=factor(name, 
                     levels=c("opebpp", "teacherpp", "classifiedpp"),
                     labels=c("total", "teachers", "classified"))) %>%
  ggplot(aes(year, value, colour=name)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name=NULL) +
  scale_y_continuous(name="$ per pupil", limits=c(0, NA)) +
  ggtitle(label="SFUSD nominal general fund OPEB expenditures on retirees, per pupil",
          subtitle="By pre-retirement job category") +
  theme_bw() +
  legend_notitle

```


```{r doc_opeb}

# documentation on selected sacs codes ------------------------------------
#.. 3101–3102 State Teachers’ Retirement System ----
# State Teachers’ Retirement System. Record expenditures to provide personnel
# with retirement benefits under the State Teachers’ Retirement System (STRS).
# This excludes employee contributions. Object 3101 is certificated personnel in
# STRS; Object 3102 includes those individuals who hold classified positions but
# are enrolled in STRS.

#.. 3201–3202 Public Employees’ Retirement System ----
# Public Employees’ Retirement System. Record expenditures to provide personnel
# with retirement benefits under the Public Employees’ Retirement System (PERS).
# This excludes employee contributions, although it does include the employer’s
# payment of an employee’s contribution. Object 3201 indicates those employees
# in certificated positions and enrolled in PERS; Object 3202 indicates
# employees in classified positions and enrolled in PERS.

#.. 3401–3402 Health and Welfare Benefits ----
# Health and Welfare Benefits. Record expenditures made to provide personnel
# with health and welfare insurance benefits. This excludes employee
# contributions but includes health and welfare benefit premiums paid to a
# self-insurance fund. Object 3401 indicates that the benefits cover
# certificated positions; Object 3402 indicates that the benefits cover
# classified positions.


#.. 3701 OPEB, Allocated, certificated positions ----
# Expenditures (1) for retirees and other former employees for current-year
# postemployment benefits other than pensions (OPEB) financed on a pay-as-you-go
# basis; or (2) for the amounts paid to an OPEB plan (administered through a
# qualifying trust) in excess of the current-year actuarially determined service
# cost. A qualifying trust is a trust or an equivalent arrangement that meets
# the criteria in paragraph 4 of GASB Statement 75. Do not include expenditures
# for service costs for active employees; these must be direct-charged using
# objects 3751–3752. Expenditures in objects 3701–3702 must be allocated to all
# activities in proportion to total salaries or total full-time equivalents
# (FTEs) in those activities. Object 3701 relates to certificated positions;
# Object 3702 relates to classified positions.

#.. 3702 OPEB, Allocated, classified positions ----
# same text

#.. 3751 OPEB, Active Employees, certificated positions ----
# Expenditures for the amounts paid to a OPEB plan (administered through a
# qualifying trust) up to the current-year actuarially determined service costs
# for OPEB-eligible active employees. A qualifying trust is a trust or an
# equivalent arrangement that meets the criteria in paragraph 4 of GASB
# Statement 75. Do not include expenditures for retirees and other former
# employees; these must be allocated using objects 3701–3702. Expenditures in
# objects 3751–3752 must be direct-charged on a per-eligible-FTE basis to the
# same resource, goal, and function as the OPEB-eligible active employee’s
# salary. Object 3751 relates to certificated positions; Object 3752 relates to
# classified positions.

#.. 3752 OPEB, Active Employees, classified positions----
# same text

#.. 9664 Total/Net OPEB Liability ----
# The total OPEB liability is the portion of the actuarial present value of
# projected benefit payments that is attributed to past periods of employee
# service, measured in conformity with the requirements of GASB Statement 75.
# For a defined benefit OPEB plan that is not administered through a trust that
# meets the criteria in paragraph 4 of GASB 75 (specified criteria), the total
# OPEB liability is reported. For a defined benefit OPEB plan that is
# administered through a trust that meets the specified criteria, a net OPEB
# liability (that is, the total OPEB liability minus the OPEB plan’s fiduciary
# net position) is reported. The total or net OPEB liability is reported only in
# the LEA’s accrual-basis financial statements.

# I don't bother to include 9664 because almost no districts report it.

```



# J-90 OPEB data
```{r j90_doc}
# TSAL517 File Contains the benefit information in Section VIII for retirees over 65
# TSAL617 File Contains the benefit information in Section VIII for retirees 65 and under

# TSAL517 and TSAL617 have essentially the same information. Here is TSAL617:
# County Two digit county code
# District Five digit district code
# CDS Seven digit combined code
# TS6_BenA one character code indicating type of benefit.  H for heath, D for dental, V for vision, L for life, O for other
# TS6_Desc The name of the plan
# TS6_Step The health benefit plans ID.  The first is always 1, the second and subsequent like plans are number consequently. This is calculated by the input program
# TS6_Column A column 1 is always Single, 2 is two party plan, 3 is family plan, 4 is composite rate
# TS6_Annual The annual cost of plan
# TS6_Contr The amount the district contributes to the cost of the plan
# TS6_FTE The number of retired teachers (age 65 or under) participating in the plan
# TS6_ID number that is generated when a J-90 is submitted. Each record has an ID number

# TS1_Maxcaf The maximum annual employer contributions to cafeteria plan.
# TS1_Maxsin The maximum annual employer contributions to single plan per employee.
# TS1_Maxtwo The maximum annual employer contributions to a two party plan per employee.
# TS1_Maxfam The maximum annual employer contributions to a family plan per employee.
# TS1_CAPTYPE Is the cap hard or soft or NA

# Ben_life	Does district cover retirees for life? (Y/N)
# Ben_stop	If not for life, when do benefits stop? Age or years
# H_plan	Number of Health plans
# D_plan	Number of dental plans
# V_plan	Number of vision plans
# L_plan	Number of life plans
# O_plan	Number of other plans

# County Two digit county code
# District Five digit district code
# CDS Seven digit combined code
# TS6_BenA one character code indicating type of benefit.  H for heath, D for dental, V for vision, L for life, O for other
# TS6_Desc The name of the plan
# TS6_Step The health benefit plans ID.  The first is always 1, the second and subsequent like plans are number consequently. This is calculated by the input program
# TS6_Column A column 1 is always Single, 2 is two party plan, 3 is family plan, 4 is composite rate
# TS6_Annual The annual cost of plan
# TS6_Contr The amount the district contributes to the cost of the plan
# TS6_FTE The number of retired teachers (age 65 or under) participating in the plan
# TS6_ID number that is generated when a J-90 is submitted. Each record has an ID number

```

```{r j90_faqs}
# excerpts from the j90 faq

# We have many benefit plans? Do I have to enter them all?
#     You don’t have to enter any plans without FTEs. If you have too many and don’t want to deal with entering all of them, you can come up with some averages.


# How do I enter my retiree plans? There are so many variables; how long they were at the district, the age they retired, etc. 	
#     Come up with some averages. I don’t want you to have to enter twenty plus plans.

# We don’t pay for our retirees. Do we still have to report them?
# 	  No. We are only interested in what the district is paying. If they are just offering the plans but the retiree has to purchase them, you do not need to do that section.
# --> seems to suggest that implicit subsidy will not appear here!!

# Our district gives each FTE $9,000 to spend on any plans they want. Some FTEs will max out before dental and vision but then some take D & V first and then apply the rest to health. How do I show this?
#     The easiest way is to enter the $9,000 on the cafeteria line where we ask for the caps. You will leave all district contributions blank. Our program will read that as everyone getting $9,000.



```

# REPORT: 4-panel plots and final table
Data prep

```{r 4panelplot_and_final_table_prep}
# get a list of all districts that offer OPEB health with values for agecat values
opeb_dists <- opeb_j90 %>%
  filter(plantype=="health", year==2020, eval(topada), opebfte > 0, agecat %in% c("under66", "age66p")) %>%
  select(year, ccode, dcode, dname, plantype, k12ada) %>%
  distinct

# get age categories and factor text so that we can create factor later after we de-factorize the variable
agecats <- opeb_j90 %>% 
  select(agecat, agecatf) %>%
  distinct() %>%
  filter(!is.na(agecat))

# create full stubs to merge against other files:
#    includes rows for all relevant districts, even if they don't provide 65+ benefits
opeb_stubs <- expand_grid(opeb_dists, 
                            agecats)
glimpse(opeb_stubs)
count(opeb_stubs, agecat, agecatf)
summary(opeb_stubs)

opeb_base_raw <- opeb_stubs %>%
  left_join(opeb_j90 %>%
              select(year, ccode, dcode, dname, plantype, agecat, opebfte, starts_with("tot")) %>%
              filter(opebfte > 0),
            by = c("year", "ccode", "dcode", "dname", "plantype", "agecat")) %>%
  select(year, ccode, dcode, dname, plantype, agecat, agecatf, k12ada, opebfte, starts_with("tot"))
# includes districts that don't offer an age category but quantitative variables (opebfte, tot...) will be NA
summary(opeb_base_raw)

# opeb_base %>% filter(eval(sfusd))
  
opeb_base <- opeb_base_raw %>%
  mutate(across(c(opebfte, starts_with("tot")),
                ~ replace_na(.x, 0)),  # set values to zero if we did not match
         across(c(opebfte, starts_with("tot")),
                ~ ifelse(.x < 0, 0, .x))) %>% # 2 oddball negatives
  group_by(year, ccode, dcode, dname, agecat, agecatf) %>%
  summarise(across(c(opebfte, starts_with("tot")), sum),
            k12ada=first(k12ada),
            .groups="drop") %>%
  mutate(across(c(totcost, totercost, toteecost),
                ~ ifelse(opebfte > 0, .x / opebfte, 0)),  # average costs 
         kfteada=opebfte / (k12ada / 1000)) 

opeb_base %>% filter(eval(sfusd))
summary(opeb_base)

# put factors in order of desired appearance in the table
fctrs <- tribble(
  ~lev, ~lab,
  "kfteada", "OPEB participants per 1,000 pupils",
  "totcost", "Total plan premium cost",
  "totercost", "District portion of plan premium cost",
  "toteecost", "Participant portion of plan premium cost",
  "ershare", "District % share of premium cost",
  "ndists", "# of districts used in calculations"
)

# note that ndists is only used in the tables, not in the plots

```


## REPORT: 4-panel plots
```{r 4panel_prep}

capt <- paste0("Source: ", j90_source)

params <- tribble(
  ~var, ~title, ~fnbase,
  "toteecost", "Retiree portion of premium in 2020, averaged across district plans", "retshare",
  "totercost", "School district portion of premium in 2020, averaged across district plans", "sdshare",
  "totcost", "Total premium (district plus retiree portions) in 2020, averaged across district plans", "totshare"
  )

```


### REPORT: 4-panel plot with all districts that provide OPEB health premium subsidies
```{r 4panel_allopeb, include=TRUE}
subt <- "Certificated retirees, by age group. Includes districts, with at least 1,000 pupils, that provide\nhealth premium subsidies in either one of the age categories."
# subt <- str_wrap(subt)
suffix <- "_allopeb.png"

pdata <- opeb_base %>%
  pivot_longer(cols=c(totcost, totercost, toteecost)) # average costs

sfusd_points <- pdata %>% 
  filter(eval(sfusd)) %>% 
  select(ccode, dcode, dname, agecat, agecatf, name, value) %>%
  mutate(label="SFUSD")

means <- pdata %>% 
  group_by(agecat, agecatf, name) %>% 
  summarise(n=n(), mean=mean(value), .groups="drop")

# var <- "toteecost"  # for test purposes

pf <- function(var){
  title <- params %>% filter(var==!!var) %>% .$title
  fnbase <- params %>% filter(var==!!var) %>% .$fnbase
  fname <- here::here("results", paste0("plancost_", fnbase, suffix))
  
  boostup <- 22
  x1 <- 1.3
  y1 <- means %>% filter(name==var, agecat=="under66") %>% .$mean + boostup
  
  x2 <- 2.3
  y2 <- means %>% filter(name==var, agecat=="age66p") %>% .$mean + boostup
  
  p <- pdata %>%
  filter(name==!!var) %>%
  ggplot(aes(x = agecatf, y = value)) +
  geom_quasirandom(fill = "grey50", 
               colour = "grey50",
               # varwidth = 1, # default is 0.5
               size=1) +
  geom_point(colour="blue", data=sfusd_points %>% filter(name==var), size=2.5) +
  geom_text(aes(label=label), data=sfusd_points %>% filter(name==var), nudge_x = 0.08, colour="blue", size=2.5) +
  stat_summary(fun = mean, 
               fun.min = mean, 
               fun.max = mean, 
               geom = "crossbar", 
               width = 0.5) +
  annotate("text", 
           x=x1, 
           y=y1,
           size=2.5, label="mean", colour="darkgreen") +
  annotate("text", 
           x=x2, 
           y=y2,
           size=2.5, label="mean", colour="darkgreen") +
  scale_y_continuous(name="Cost per particpant", 
                     breaks=seq(0, 30e3, 5e3), 
                     limits=c(0, 30e3), 
                     labels=label_comma(prefix="$")) +
  scale_x_discrete(name=NULL) +
  ggtitle(title,
          subtitle=subt) +
  labs(caption=capt) +
  theme_bw() +
  caption_left
  # ggsave(plot=p, filename=fname, width=8, height=8, units="in")
  p
}

p_tot_mean <- pf("totcost")
p_ee_mean <- pf("toteecost")
p_er_mean <- pf("totercost")

#.. now plot opebftes per ada ----
pdatanew <- pdata %>%
  filter(name=="totcost") %>%
  mutate(kfteada=opebfte / (k12ada / 1000)) %>%
  select(year, ccode, dcode, dname, agecat, agecatf, opebfte, k12ada, kfteada)

sfusd_pointsnew <- pdatanew %>% 
  filter(eval(sfusd)) %>% 
  select(ccode, dcode, dname, agecat, agecatf, opebfte, k12ada, kfteada) %>%
  mutate(label="SFUSD")

meansnew <- pdatanew %>% 
  group_by(agecat, agecatf) %>% 
  summarise(n=n(), mean=mean(kfteada), .groups="drop")

title <- "District-reported number of OPEB participants (FTE), shown per 1,000 pupils (calculated)"
fname <- here::here("results", paste0("fteada_means", suffix))
  
boostup <- 0.5
x1 <- 1.3
y1 <- meansnew %>% filter(agecat=="under66") %>% .$mean + boostup
  
x2 <- 2.3
y2 <- meansnew %>% filter(agecat=="age66p") %>% .$mean + boostup
  
p_fte_mean <- pdatanew %>%
  ggplot(aes(x = agecatf, y = kfteada)) +
  geom_quasirandom(fill = "grey50", 
               colour = "grey50",
               size=1) +
  geom_point(colour="blue", data=sfusd_pointsnew, size=2.5) +
  geom_text(aes(label=label), data=sfusd_pointsnew, nudge_x = 0.08, colour="blue", size=2.5) +
  stat_summary(fun = mean, 
               fun.min = mean, 
               fun.max = mean, 
               geom = "crossbar", 
               width = 0.5) +
  annotate("text", 
           x=x1, 
           y=y1,
           size=2.5, label="mean", colour="darkgreen") +
  annotate("text", 
           x=x2, 
           y=y2,
           size=2.5, label="mean", colour="darkgreen") +
  scale_y_continuous(name="Number of particpants per 1,000 pupils", 
                     # breaks=seq(0, 30e3, 5e3), 
                     # limits=c(0, 30e3), 
                     labels=label_comma()) +
  scale_x_discrete(name=NULL) +
  ggtitle(title,
          subtitle=subt) +
  labs(caption=capt) +
  theme_bw() +
  caption_left

p_fte_mean

# ggsave(plot=p_fte_mean, filename=fname, width=8, height=8, units="in")


#.. combine plots ----
p <- p_fte_mean + p_tot_mean + p_ee_mean + p_er_mean + plot_layout(ncol = 2)
p
ggsave(plot=p, filename=here::here("results", paste0("combined_means", suffix)), width=12, height=8, units="in", scale=1.5)

```


### REPORT APPENDIX: 4-panel plot including only districts that provide premium subsidy for an age category
```{r 4panel_categoryopeb, include=TRUE}
subt <- "Certificated retirees, by age group. Includes districts, with at least 1,000 pupils, that provide\nhealth premium subsidies in the given age category."
# subt <- str_wrap(subt)
suffix <- "_categoryopeb.png"

pdata <- opeb_base %>%
  filter(opebfte > 0) %>%
  pivot_longer(cols=c(totcost, totercost, toteecost)) # average costs

sfusd_points <- pdata %>% 
  filter(eval(sfusd)) %>% 
  select(ccode, dcode, dname, agecat, agecatf, name, value) %>%
  mutate(label="SFUSD")

means <- pdata %>% 
  group_by(agecat, agecatf, name) %>% 
  summarise(n=n(), mean=mean(value), .groups="drop")

# var <- "toteecost"  # for test purposes

pf <- function(var){
  title <- params %>% filter(var==!!var) %>% .$title
  fnbase <- params %>% filter(var==!!var) %>% .$fnbase
  fname <- here::here("results", paste0("plancost_", fnbase, suffix))
  
  boostup <- 22
  x1 <- 1.3
  y1 <- means %>% filter(name==var, agecat=="under66") %>% .$mean + boostup
  
  x2 <- 2.3
  y2 <- means %>% filter(name==var, agecat=="age66p") %>% .$mean + boostup
  
  p <- pdata %>%
  filter(name==!!var) %>%
  ggplot(aes(x = agecatf, y = value)) +
  geom_quasirandom(fill = "grey50", 
               colour = "grey50",
               size=1) +
  geom_point(colour="blue", data=sfusd_points %>% filter(name==var), size=2.5) +
  geom_text(aes(label=label), data=sfusd_points %>% filter(name==var), nudge_x = 0.08, colour="blue", size=2.5) +
  stat_summary(fun = mean, 
               fun.min = mean, 
               fun.max = mean, 
               geom = "crossbar", 
               width = 0.5) +
  annotate("text", 
           x=x1, 
           y=y1,
           size=2.5, label="mean", colour="darkgreen") +
  annotate("text", 
           x=x2, 
           y=y2,
           size=2.5, label="mean", colour="darkgreen") +
  scale_y_continuous(name="Cost per particpant", 
                     breaks=seq(0, 30e3, 5e3), 
                     limits=c(0, 30e3), 
                     labels=label_comma(prefix="$")) +
  scale_x_discrete(name=NULL) +
  ggtitle(title,
          subtitle=subt) +
  labs(caption=capt) +
  theme_bw() +
  caption_left
  # ggsave(plot=p, filename=fname, width=8, height=8, units="in")
  p
}

p_tot_mean <- pf("totcost")
p_ee_mean <- pf("toteecost")
p_er_mean <- pf("totercost")

#.. now plot opebftes per ada ----
pdatanew <- pdata %>%
  filter(name=="totcost") %>%
  mutate(kfteada=opebfte / (k12ada / 1000)) %>%
  select(year, ccode, dcode, dname, agecat, agecatf, opebfte, k12ada, kfteada)

sfusd_pointsnew <- pdatanew %>% 
  filter(eval(sfusd)) %>% 
  select(ccode, dcode, dname, agecat, agecatf, opebfte, k12ada, kfteada) %>%
  mutate(label="SFUSD")

meansnew <- pdatanew %>% 
  group_by(agecat, agecatf) %>% 
  summarise(n=n(), mean=mean(kfteada), .groups="drop")

title <- "District-reported number of OPEB participants (FTE), shown per 1,000 pupils (calculated)"
fname <- here::here("results", paste0("fteada_means", suffix))
  
boostup <- 0.5
x1 <- 1.3
y1 <- meansnew %>% filter(agecat=="under66") %>% .$mean + boostup
  
x2 <- 2.3
y2 <- meansnew %>% filter(agecat=="age66p") %>% .$mean + boostup
  
p_fte_mean <- pdatanew %>%
  ggplot(aes(x = agecatf, y = kfteada)) +
  geom_quasirandom(fill = "grey50", 
               colour = "grey50",
               size=1) +
  geom_point(colour="blue", data=sfusd_pointsnew, size=2.5) +
  geom_text(aes(label=label), data=sfusd_pointsnew, nudge_x = 0.08, colour="blue", size=2.5) +
  stat_summary(fun = mean, 
               fun.min = mean, 
               fun.max = mean, 
               geom = "crossbar", 
               width = 0.5) +
  annotate("text", 
           x=x1, 
           y=y1,
           size=2.5, label="mean", colour="darkgreen") +
  annotate("text", 
           x=x2, 
           y=y2,
           size=2.5, label="mean", colour="darkgreen") +
  scale_y_continuous(name="Number of particpants per 1,000 pupils", 
                     # breaks=seq(0, 30e3, 5e3), 
                     # limits=c(0, 30e3), 
                     labels=label_comma()) +
  scale_x_discrete(name=NULL) +
  ggtitle(title,
          subtitle=subt) +
  labs(caption=capt) +
  theme_bw() +
  caption_left

p_fte_mean

# ggsave(plot=p_fte_mean, filename=fname, width=8, height=8, units="in")


#.. combine plots ----
p <- p_fte_mean + p_tot_mean + p_ee_mean + p_er_mean + plot_layout(ncol = 2)
p
ggsave(plot=p, filename=here::here("results", paste0("combined_means", suffix)), width=12, height=8, units="in", scale=1.5)

```

## REPORT: Final summary table of plan costs and ftes

```{r final_table_data_prep}
ndists <- opeb_base %>%
  group_by(agecat, agecatf) %>%
  summarise(opebdists=n(),
            agecatdists=sum(opebfte > 0),
            .groups="drop") %>%
  pivot_longer(cols=-c(agecat, agecatf), names_to = "tabletype", values_to = "mean") %>%
  mutate(name="ndists")

```


### REPORT BODY: Final summary table including all OPEB districts in the age 65+ statistics
```{r plan_costs_ftes_means_allopeb, include=TRUE}
# this version includes all districts regardless of whether they provide benefits in an age category
distcosts <- opeb_base %>%
  select(year, ccode, dcode, dname, agecat, agecatf, starts_with("tot")) %>%
  pivot_longer(cols=c(totcost, totercost, toteecost))

distftes <- opeb_base %>%
  select(year, ccode, dcode, dname, agecat, agecatf, value=kfteada) %>%
  mutate(name="kfteada")

distvals <- bind_rows(distcosts, distftes) %>%
  arrange(year, ccode, dcode, dname, agecat, name)

sfusdvals <- distvals %>%
  filter(eval(sfusd)) %>%
  mutate(group="SFUSD")

meanvals <- distvals %>%
  group_by(agecat, agecatf, name) %>%
  summarise(value=mean(value), .groups="drop") %>%
  mutate(group="mean")

vals <- c("kfteada")

tabdata <- bind_rows(meanvals, sfusdvals) %>%
  select(group, agecat, agecatf, name, value) %>%
  pivot_wider() %>%
  mutate(ershare=totercost / totcost) %>%
  pivot_longer(cols=-c(group, agecat, agecatf)) %>%
  pivot_wider(names_from = group) %>%
  bind_rows(ndists %>% 
              filter(tabletype=="opebdists") %>% 
              select(-tabletype)) %>%
  mutate(pctdiff=ifelse(name=="ershare", SFUSD - mean, SFUSD / mean - 1),
         name=factor(name, levels=fctrs$lev, labels=fctrs$lab)) %>%
  arrange(agecat, name)

tab <- tabdata %>%
  select(-agecat) %>%
  group_by(agecatf) %>%
  gt() %>%
  tab_header(
      title = paste0("Retiree health plan participants and premium costs"),
      subtitle = "Under 65 and Age 65+ retirees"
    ) %>%
  cols_label(
    name="",
    mean=html("Mean across all<br>districts with<br>OPEB benefits"),
    pctdiff=html("SFUSD %<br>above or<br>below mean")
  ) %>%
  cols_align(
    align="left",
    columns=name
  ) %>%
  fmt_currency(
    columns = c(mean, SFUSD),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_number(
    columns=c(mean, SFUSD),
    rows=c(1, 7),
    decimals=1
  ) %>%
  fmt_number(
    columns=c(mean, SFUSD),
    rows=c(6, 12),
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(mean, SFUSD),
    rows=c(5, 11),
    decimals = 1
  ) %>%
  fmt_percent(
    columns = pctdiff,
    decimals = 1
  ) %>%
  fmt_missing(columns = c(SFUSD, pctdiff)) %>%
  cols_width(
    c(mean, SFUSD, pctdiff) ~ px(160),
    name ~ px(270)
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey90"),
      cell_text(size = px(15), weight = "bold", font = "arial")
      ),
    locations = cells_row_groups()
  ) %>%
  tab_footnote(
    footnote = "Calculated as SFUSD minus mean.",
    locations = cells_body(
      columns = pctdiff,
      rows = str_detect(name, "%"))
  ) %>%
  tab_source_note(paste0("Source: ", j90_source))

tab  

gtsave(tab, here::here("results", "j90_sfusd_vs_means_allopeb.png"))  # , zoom = 1.5, expand = 10)
write_csv(tabdata, here::here("results", "j90_sfusd_vs_means_allopeb_data.csv"))

```

### REPORT APPENDIX: Final summary table that limits age 65+ statistics to districts offering this coverage
```{r plan_costs_ftes_means_categoryopeb, include=TRUE}
# this version includes only districts that provide benefits in an age category
opeb_category <- opeb_base %>%
  filter(opebfte > 0)

distcosts <- opeb_category %>%
  select(year, ccode, dcode, dname, agecat, agecatf, starts_with("tot")) %>%
  pivot_longer(cols=c(totcost, totercost, toteecost))

distftes <- opeb_category %>%
  select(year, ccode, dcode, dname, agecat, agecatf, value=kfteada) %>%
  mutate(name="kfteada")

distvals <- bind_rows(distcosts, distftes) %>%
  arrange(year, ccode, dcode, dname, agecat, name)

sfusdvals <- distvals %>%
  filter(eval(sfusd)) %>%
  mutate(group="SFUSD")

meanvals <- distvals %>%
  group_by(agecat, agecatf, name) %>%
  summarise(value=mean(value), .groups="drop") %>%
  mutate(group="mean")

tabdata <- bind_rows(meanvals, sfusdvals) %>%
  select(group, agecat, agecatf, name, value) %>%
  pivot_wider() %>%
  mutate(ershare=totercost / totcost) %>%
  pivot_longer(cols=-c(group, agecat, agecatf)) %>%
  pivot_wider(names_from = group) %>%
  bind_rows(ndists %>% 
              filter(tabletype=="agecatdists") %>% 
              select(-tabletype)) %>%
  mutate(pctdiff=ifelse(name=="ershare", SFUSD - mean, SFUSD / mean - 1),
         name=factor(name, levels=fctrs$lev, labels=fctrs$lab)) %>%
  arrange(agecat, name)

tab <- tabdata %>%
  select(-agecat) %>%
  group_by(agecatf) %>%
  gt() %>%
  tab_header(
      title = paste0("Retiree health plan participants and premium costs"),
      "Under 65 and Age 65+ retirees"
    ) %>%
  cols_label(
    name="",
    mean=html("Mean across districts<br>providing benefits<br>in age category"),
    pctdiff=html("SFUSD %<br>above or<br>below mean")
  ) %>%
  # cols_align(align="center") %>%
  cols_align(
    align="left",
    columns=name
  ) %>%
  # cols_align(align="left") %>%
  fmt_currency(
    columns = c(mean, SFUSD),
    decimals = 0,
    suffixing = FALSE
  ) %>%
  fmt_number(
    columns=c(mean, SFUSD),
    rows=c(1, 7),
    decimals=1
  ) %>%
  fmt_number(
    columns=c(mean, SFUSD),
    rows=c(6, 12),
    decimals=0
  ) %>%
  fmt_percent(
    columns = c(mean, SFUSD),
    rows=c(5, 11),
    decimals = 1
  ) %>%
  fmt_percent(
    columns = pctdiff,
    decimals = 1
  ) %>%
  fmt_missing(columns = c(SFUSD, pctdiff)) %>%
  cols_width(
    c(mean, SFUSD, pctdiff) ~ px(160),
    name ~ px(270)
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey90"),
      cell_text(size = px(15), weight = "bold", font = "arial")
      ),
    locations = cells_row_groups()
  ) %>%
  tab_footnote(
    footnote = "Calculated as SFUSD minus mean.",
    locations = cells_body(
      columns = pctdiff,
      rows = str_detect(name, "%"))
  ) %>%
  tab_source_note(paste0("Source: ", j90_source))

tab  

gtsave(tab, here::here("results", "j90_sfusd_vs_means_categoryopeb.png"))  # , zoom = 1.5, expand = 10)
write_csv(tabdata, here::here("results", "j90_sfusd_vs_means_categoryopeb_data.csv"))
```



# REPORT SFUSD SPECIFIC PLANS
## JUST FOR HTML: SFUSD by plan type - cost and ftes
```{r plantype, include=TRUE}
rows <- opeb_j90 %>%
  filter(eval(sfusd), year==2020, opebfte > 0) %>%
  group_by(plantype) %>%
  summarise(n=n(), minfte=min(opebfte), maxfte=max(opebfte), sumfte=sum(opebfte), 
            totcost=sum(totcost), totercost=sum(totercost), toteecost=sum(toteecost),
            .groups="drop") %>%
  select(plantype, n, minfte, maxfte, sumfte, toteecost, totercost, totcost)

sumrow <- rows %>%
  summarise(across(c(n, starts_with("tot")),  sum),
            sumfte=max(sumfte),
            minfte=min(minfte),
            maxfte=max(maxfte)) %>%
  mutate(plantype="  Totals/min/max",
         across(starts_with("tot"), ~.x / 1e6))

tabdata <- bind_rows(rows, sumrow) %>%
  mutate(across(starts_with("tot"), ~.x / 1e6), 
         ershare=totercost / totcost)

tabdata %>%
  gt() %>%
  tab_header(
      title = "SFUSD estimated OPEB FTEs and costs, plan year 2020",
      subtitle = "Source: J-90 data"
    )  %>%
  cols_label(
    n=html("Number<br>of plans"),
    minfte="min",
    maxfte="max",
    sumfte="total",
    toteecost=html("Total employee cost"),
    totercost=html("Total employer cost"),
    totcost=html("Total cost"),
    ershare=html("Employer share")
  ) %>%
  tab_spanner(label="# of OPEB FTEs (i.e., retirees)",
              columns=contains("fte")
              ) %>%
  tab_spanner(
    label = "$ millions",
    columns = contains("tot")
    ) %>%
    fmt_number(
      columns = c(n, contains("fte")),
      decimals = 0,
      suffixing = FALSE
    )  %>%
    fmt_number(
      columns = contains("tot"),
      decimals = 2,
      suffixing = FALSE
    ) %>%
    fmt_percent(
      columns = ershare,
      decimals = 1
    )%>%
  tab_footnote(
    footnote = "CAUTION: cost estimates based on J-90 are overestimates but employer share is plausible.",
    locations = cells_column_labels(
      columns = starts_with("tot")
    )
  )

```

# REPORT: Scatter of SFUSD health plans particpants and participant-cost
```{r sfusd_health_scatter, include=TRUE}
pdata <- opeb_j90 %>%
  filter(eval(sfusd)) %>%
  filter(plantype=="health") %>%
  filter(year==2020) %>%
  mutate(erpct=totercost / sum(totercost),
         coverage=as.character(coverage),
         coverage=ifelse(coverage=="twoparty", "two party", coverage),
         costshare=percent(erpct, accuracy=.1),
         lbl=ifelse(erpct > .05, costshare, ""),
         ercost=comma(planercost, accuracy=1, prefix="$"),
         plan=paste0(provider, "-", coverage))

capt <- paste0("Source: ", j90_source)

p <- pdata %>%
  ggplot(aes(x=planeecost, y=opebfte, size=erpct, colour=agecatf, label=lbl)) +
  geom_point() +
  geom_text(nudge_x = 300, size=3, hjust=0, ) +
  scale_y_continuous("# of retirees in the plan", labels = scales::label_comma()) +
  scale_x_continuous("Annual cost to the plan member", labels=scales::label_comma(prefix="$")) +
  scale_size_continuous(guide = "none") +
  scale_colour_manual(values=c("darkgreen", "blue")) +
  ggtitle("SFUSD Retiree health plans for certificated staff in 2020",
          "Size of dot and number represent share of employer OPEB costs for certificated retirees.") +
  labs(caption=capt) +
  theme_bw() +
  caption_left +
  legend_notitle

p
    
ggsave(plot=p, filename=here::here("results", "sfusd_plans.png"), width=10, height=6.5, units="in")
write_csv(pdata, here::here("results", "sfusd_plans_data.csv"))

```



# REPORT SELECTED FACTS

# District costs by whether district provides benefits for ages 65+
```{r}
ben65p <- opeb_j90 %>%
  filter(year==2020) %>%
  mutate(ben65p=(ben_stop > 65) | (ben_life=="Y")) %>%
  select(ccode, dcode, dname, ben65p) %>%
  distinct

healdsburg <- expression(ccode==49 & dcode==75390) # outlier opebpp = 1169.9121

pdata1 <- ben65p %>%
  select(ccode, dcode, ben65p) %>%
  inner_join(opebdf %>% 
              filter(year==2020, opebpp >= 0, k12ada >= 1000),
            by = c("ccode", "dcode")) %>%
  filter(!eval(healdsburg)) %>%
  select(ccode, dcode, dname, ben65p, opebpp, sfusd)

counts <- count(pdata1, ben65p)
labs <- c("District does not provide age 65+ benefits\n", "District provides age 65+ benefits\n")
labs <- paste0(labs, "(n=", counts$n, ")")
labs

pdata <- pdata1 %>%
  mutate(ben65p=factor(ben65p,
                       levels=c(FALSE, TRUE),
                       labels=labs, 25))


capt <- paste0("Source: ", sacs_source, " and ", j90_source, ".\n",
               "Note:  Only includes districts with at least 1,000 pupils, for which benefit age limit is reported. Outlier Healdsburg ($1,170 per pupil) excluded.")

sfusd_points <- pdata %>% filter(eval(sfusd)) %>% select(ccode, dcode, dname, ben65p, opebpp) %>%
  mutate(label="SFUSD")

mdns <- pdata %>% group_by(ben65p) %>% summarise(mdn=median(opebpp))

p <- pdata %>%
  ggplot(aes(x = ben65p, y = opebpp)) +
  geom_quasirandom(fill = "grey50", 
               colour = "grey50",
               size=1)  +
  geom_point(colour="blue", data=sfusd_points, size=2.5) +
  geom_text(aes(label=label), data=sfusd_points, nudge_x = 0.06, colour="blue", size=2.5) +
  stat_summary(fun = median, 
               fun.min = median, 
               fun.max = median, 
               geom = "crossbar", 
               width = 0.5) +
  annotate("text", x=1.28, y=mdns$mdn[1] + 10, size=2.5, label="median", colour="darkgreen") +
  annotate("text", x=2.28, y=mdns$mdn[2] + 10, size=2.5, label="median", colour="darkgreen") +
  scale_y_continuous(name="Expenditures per pupil", 
                     breaks=seq(0, 700, 100), 
                     limits=c(0, NA), 
                     labels=label_comma(prefix="$")) +
  scale_x_discrete(name=NULL) +
  ggtitle("School district retiree health care expenditures per pupil",
          subtitle="By whether district provides benefits for age 65 and above") +
  labs(caption=capt) +
  theme_bw() +
  caption_left
p

ggsave(plot=p, filename=here::here("results", "opebpp_age_dots.png"), width=10, height=8, units="in")
write_csv(pdata, here::here("results", "opebpp_age_dots_data.csv"))

# p <- pdata %>%
#   ggplot(aes(ben65p, opebpp)) +
#   geom_boxplot(fill="slateblue", alpha=0.2, outlier.shape = NA, coef=0, notch=TRUE) +
#   geom_point(colour="blue", data=sfusd_points, size=3) +
#   geom_text(aes(label=label), data=sfusd_points, nudge_x = 0.2, colour="blue") +
#   scale_y_continuous(name="Expenditures per pupil", 
#                      breaks=seq(0, 700, 100), 
#                      limits=c(0, 600), 
#                      labels=label_comma(prefix="$")) +
#   scale_x_discrete(name=NULL) +
#   ggtitle("School district retiree health care expenditures per pupil",
#           subtitle="By whether district provides benefits for age 65 and above") +
#   labs(caption=capt) +
#   theme_bw() +
#   caption_left
# p

```



# NOT FOR REPORT OPEB costs by age
```{r costs_byage, include=FALSE}
costs <- opeb_j90 %>%
  filter(eval(topada), plantype=="health", year==2020) %>%
  group_by(ccode, dcode, dname, agecat) %>%
  summarise(across(starts_with("tot"), sum), .groups = "drop") %>%
  pivot_longer(cols=starts_with("tot")) %>%
  pivot_wider(names_from=agecat, values_fill = 0) %>%
  filter(age66p > 0) %>%
  mutate(agetot=under66 + age66p,
         pct66p=age66p / agetot)

costs %>% filter(eval(sfusd))

costs %>% filter(ccode==19, dcode==64733)

costs %>%
  group_by(name) %>%
  summarise(pct66p_mean=mean(pct66p),
            pct66_median=median(pct66p))

opeb_j90 %>%
  filter(eval(topada), plantype=="health", year==2020)

```

# NOT FOR REPORT: SFUSD OPEB by age category
```{r include=TRUE}
rows <- opeb_j90 %>%
  filter(eval(sfusd), year==2020, opebfte > 0, plantype=="health") %>%
  group_by(agecat) %>%
  summarise(across(starts_with("tot"), sum))

tabdata <- rows %>%
  bind_rows(rows %>% summarise(across(starts_with("tot"), sum)) %>%
              mutate(agecat="total")) %>%
  pivot_longer(-agecat) %>%
  pivot_wider(names_from = agecat) %>%
  mutate(name=factor(name,
                     levels=c("totercost", "toteecost", "totcost"),
                     labels=c("District", "Retiree", "Total")),
         age66pshare=age66p / total) %>%
  arrange(name)


tabdata %>%
  gt() %>%
  tab_header(
      title = "SFUSD estimated retiree and district costs by age group, plan year 2020",
      subtitle = "Source: J-90 data"
    )  %>%
  cols_label(
    name="Cost paid by:",
    under66=html("Under age 66"),
    age66p=html("Age 66+"),
    total=("Total"),
    age66pshare=html("Age 66+ as %<br>of total cost")
  ) %>%
  fmt_number(
      columns = c(under66, age66p, total),
      decimals = 0,
      suffixing = FALSE
    )  %>%
  fmt_percent(
      columns = age66pshare,
      decimals = 1
    ) %>%
  tab_footnote(
    footnote = "CAUTION: cost estimates based on J-90 may be overestimates.",
    locations = cells_column_labels(
      columns = c(under66, age66p, total)
    )
  )

```

# REPORT: SFUSD cost shares table
```{r cost_shares, include=TRUE}
topn <- 3
srcnote <- paste0(j90_source, ", as reported by SFUSD.")

tabdata1 <- opeb_j90 %>%
  filter(eval(sfusd)) %>%
  filter(plantype=="health") %>%
  filter(year==2020) %>%
  mutate(erpct=totercost / sum(totercost),
         coverage=as.character(coverage),
         coverage=ifelse(coverage=="twoparty", "two party", coverage)) %>%
  select(year, ccode, dcode, dname, provider, coverage, agecat, agecatf, erpct, opebfte, 
         planercost, planeecost, plancost,
         totercost, toteecost, totcost) %>% 
  arrange(desc(erpct)) %>%
  group_by(agecatf) %>%
  mutate(topn=ifelse(row_number() <= !!topn, TRUE, FALSE)) %>%
  ungroup

other <- tabdata1 %>%
  filter(!topn) %>%
  group_by(year, ccode, dcode, dname, agecat, agecatf, topn) %>%
  summarise(across(c(erpct, opebfte, totercost, toteecost, totcost), sum), .groups="drop") %>%
  mutate(planercost=totercost / opebfte,
         planeecost=toteecost / opebfte,
         plancost=totcost / opebfte)

tabdata2 <- bind_rows(tabdata1 %>% 
                        filter(topn) %>% 
                        mutate(group=1),
                     other %>% 
                       mutate(group=2)) %>%
  arrange(desc(agecatf), group, desc(erpct)) %>%
  mutate(plan=ifelse(topn, paste0(provider, ": ", coverage), "All other"),
         agecat=as.character(agecat)) %>%
  select(group, agecat, agecatf, plan, erpct, opebfte, plancost, planeecost, planercost)

# precompute the complex averages for each group and in total
subtotals <- tabdata2 %>%
  group_by(agecat, agecatf) %>%
  summarise(across(contains("cost"), ~ sum(.x * opebfte) / sum(opebfte)),
            across(c(erpct, opebfte), sum),
            .groups="drop") %>%
  mutate(group=3)

totals <- tabdata2 %>%
  summarise(across(contains("cost"), ~ sum(.x * opebfte) / sum(opebfte)),
            across(c(erpct, opebfte), sum),
            .groups="drop") %>%
  mutate(group=4, agecat="total", agecatf="")

tabdata <- bind_rows(tabdata2, 
                     subtotals %>% mutate(plan="  Subtotal"), 
                     totals %>% mutate(plan="  Grand total")) %>%
  mutate(agecatf=factor(agecat,
                       levels=c("under66", "age66p", "total"),
                       labels=c("Under 65", "Age 65+", ""))) %>%
  arrange(agecatf, group, desc(erpct))


# note - precompute subtotals and totals because gt cannot do complex subtotals
tab <- tabdata %>%
  group_by(agecatf) %>%
  gt() %>%
  cols_hide(c(group, agecat)) %>%
  tab_header(
      title = "SFUSD health plans for certificated retirees",
      subtitle = "Three most-costly plans for SFUSD in each age category, plus All other"
    ) %>%
  cols_label(
    plan="",
    erpct=html("Share of SFUSD<br>OPEB cost"),
    opebfte=html("# of retirees<br>(FTE)"),
    plancost=html("Total<br>cost"),
    planeecost=html("Member<br>cost"),
    planercost=html("SFUSD<br>cost")
  ) %>%
  tab_spanner(label="Plan cost per participant",
              columns = c(plancost, planeecost, planercost)) %>%
  fmt_number(
    columns = c(opebfte, contains("cost")),
    decimals = 0,
    suffixing = FALSE
    ) %>%
  fmt_number(
    columns = c(contains("cost")),
    rows = c(1, 5, 6, 10, 11),
    decimals = 0,
    pattern = "${x}",
    suffixing = FALSE
    ) %>%
  fmt_percent(
      columns = erpct,
      decimals = 1
    ) %>%
  fmt_missing(columns=c(plan)) %>%
  tab_style(
    style = list(
      cell_text(style = "italic")
      ),
    locations = cells_body(
      rows = c(5, 10)
      )
    ) %>%
  tab_style(
    style = list(
      cell_borders(sides = "top", color = "#000000", style = "solid", weight = px(1.5))
      ),
    locations = cells_body(
      rows = c(5, 10),
      columns=erpct:planercost
      )
    ) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey90"),
      # cell_text(style = "oblique")
      cell_text(size = px(15), weight = "bold", font = "arial")
      ),
    locations = cells_row_groups()
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "grey90"),
      cell_text(size = px(15), weight = "bold", font = "arial")
      ),
    locations = cells_body(
      rows = nrow(tabdata))
      ) %>%
  tab_source_note(paste0("Source: ", srcnote))

tab

gtsave(tab, here::here("results", "sfusd_opeb_top_plans.png"))  # , zoom = 1.5, expand = 10)
write_csv(tabdata, here::here("results", "sfusd_opeb_top_plans_data.csv"))


```

## FACTS FOR REPORT TEXT: J90 districts providing benefits beyond age 65
```{r age65p_distpercents, include=TRUE}
base <- opeb_j90 %>%
  select(year, ccode, dcode, dname, ben_life, ben_stop, agecat, k12ada, opebfte, starts_with("tot")) %>%
  group_by(year, ccode, dcode, dname, ben_life, ben_stop, agecat) %>%
  summarise(k12ada=first(k12ada),
            across(c(opebfte, starts_with("tot")), sum), 
            .groups="drop") %>%
  pivot_wider(names_from = agecat,
              names_glue = "{agecat}_{.value}",
              values_from = c(opebfte, starts_with("tot")),
              values_fill = 0)
# count(base, year)

base2 <- base %>%
  mutate(
    # district definitions for numerator
    n_indata=1,
    n_benstop65p=ben_stop > 65,
    n_benlife=ben_life=="Y",
    n_ben65plife=n_benstop65p & n_benlife,
    n_benagecat65p=age66p_opebfte > 0) 

age65p_all <- base2 %>%
  group_by(year) %>%
  summarise(across(starts_with("n_"), sum)) %>%
  mutate(across(-c(year, n_indata), ~ .x / n_indata)) %>%
  gt() %>%
  tab_header(
    title = "All districts",
    subtitle = "Source: J-90 data"
    ) 
  
age65p_topada <- base2 %>%
  filter(eval(topada)) %>%
  group_by(year) %>%
  summarise(across(starts_with("n_"), sum)) %>%
  mutate(across(-c(year, n_indata), ~ .x / n_indata)) %>%
  gt() %>%
  tab_header(
    title = "Districts with >= 1000 pupils",
    subtitle = "Source: J-90 data"
    ) 

age65p_topadaopebfte <- base2 %>%
  filter(eval(topada), under66_opebfte > 0) %>%
  group_by(year) %>%
  summarise(across(starts_with("n_"), sum)) %>%
  mutate(across(-c(year, n_indata), ~ .x / n_indata)) %>%
  gt() %>%
  tab_header(
    title = "Districts with >= 1000 pupils and postive # of opeb ftes",
    subtitle = "Source: J-90 data"
    ) 
  
age65p_all
age65p_topada
age65p_topadaopebfte

```
## FACTS FOR REPORT TEXT: J90 65+ costs as percent
```{r age65plus_costs, include=TRUE}
base <- opeb_j90 %>%
  select(year, ccode, dcode, dname, ben_life, ben_stop, agecat, k12ada, opebfte, starts_with("tot")) %>%
  group_by(year, ccode, dcode, dname, ben_life, ben_stop, agecat) %>%
  summarise(k12ada=first(k12ada),
            across(c(opebfte, starts_with("tot")), sum), 
            .groups="drop") %>%
  pivot_wider(names_from = agecat,
              names_glue = "{agecat}_{.value}",
              values_from = c(opebfte, starts_with("tot")),
              values_fill = 0)

costs <- base %>%
  filter(eval(topada), under66_opebfte > 0) %>%
  group_by(year) %>%
  select(year, ccode, dcode, dname, under66_totercost, age66p_totercost) %>%
  mutate(totercost=age66p_totercost + under66_totercost,
         erpct=age66p_totercost / totercost) %>%
  ungroup

costs %>% filter(eval(sfusd))

costs %>%
  filter(erpct > 0) %>%
  group_by(year) %>%
  summarise(qtiledf(erpct))

```


