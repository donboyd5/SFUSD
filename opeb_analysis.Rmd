---
title: "OPEB analysis"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook: 
    df_print: paged
    fig_height: 6
    fig_width: 8
    toc: yes
    number_sections: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, eval=TRUE, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}

# note that eval=TRUE unless set to FALSE
# to have a chunk's output show in the html file, set include=TRUE in the chunk's options

knitr::opts_chunk$set(eval=TRUE, include=FALSE, echo=FALSE, rows.print=20)
options(width = 150)
```

```{r libraries}
library(tidyverse)
options(tibble.print_max = 80, tibble.print_min = 80) # if more than nn rows, print 60 - enough for states
library(readxl)
library(scales)
library(lubridate)

library(btools)

# tables
library(knitr)
library(kableExtra)
library(DT)
library(gt)

library(maps)
# https://cran.r-project.org/web/packages/usmap/vignettes/mapping.html
library(usmap)
library(gridExtra)
library(RcppRoll)
library(ggrepel)
library(ggbreak)
library(patchwork)
library(RColorBrewer)

library(fredr)

```

```{r constants}
fred_apikey <- "a5e1199baac333154cbffcba3b263c28"
fredr_set_key(fred_apikey)

dsacs <- r"(E:\data\CA_sacs/)"
dsacs_all <- paste0(dsacs, "data/allyears/")

dj90 <- r"(E:\data\CA_j90/)"
dj90_all <- paste0(dj90, "data/allyears/")

#.. graph theme items ----
legend_none <- theme(legend.position = "None")
legend_notitle <- theme(legend.title = element_blank())
caption_left <- theme(plot.caption = element_text(hjust = 0))


```

```{r logical_expressions}
sfusd <- expression(ccode==38 & dcode==68478)
```

# Marc Joffe's OPEB data

```{r joffe}
mjfn <- "OPEB Study Data 2021-02-18.xlsx"

mj1 <- read_excel(here::here("data", mjfn), sheet="OPEB Study Data")
# glimpse(mj1)
# summary(mj1)

mj2 <- mj1 %>%
  select(-...10) %>%
  rename(stabbr=state,
         penrev=`pension/revenue`,
         opebrev=`opeb/revenue`)
# summary(mj2)
# count(mj2, stabbr)

mjsd <- mj2 %>%
  filter(str_detect(name, coll("school", ignore_case = TRUE)))


```

## Large California, Nevada, and Oregon school districts in 2019: pensions and OPEB as % of revenue

SFUSD has 7th highest OPEB liability as % of total revenue, among large school districts in California, Nevada, and Oregon (defined as those that have at least \$100 million in revenue).

```{r mj_largesd, include=TRUE}
mjsd %>%
  filter(stabbr %in% c("CA", "NV", "OR"), total_revenues >= 100e6) %>%
  arrange(desc(opebrev)) %>%
  select(-c(year, opeb_liabilities_elsewhere)) %>%
  datatable(caption="California, Nevada, and Oregon school districts in 2019 with total revenues >= $100m. Source: Marc Joffe",
            options=list(warn.size=FALSE,
                         pageLength = 20)) %>%
  formatCurrency(
    columns=c("pension_debt", "opeb_debt", "total_revenues"),
    currency = "",
    digits=0,
    interval = 3, 
    mark = ",") %>%
  formatPercentage(
    columns = c("penrev", "opebrev"),
    digits=1)

```

# SACS financial data

```{r load_sacs}
system.time(all_sacs <- readRDS(paste0(dsacs_all, "all_sacs.rds")))  # 30 secs
sacs_gfcurrent <- readRDS(file=paste0(dsacs_all, "sacs_gfcurrent.rds"))
leas <- readRDS(file=paste0(dsacs_all, "leas.rds"))  # local education agencies -- for k12ada


```

## SFUSD Health, pension, and OPEB benefits as % of general fund

```{r shares, include=TRUE, fig.width=10, fig.height=6.5}
pdata <- sacs_gfcurrent %>%
  filter(eval(sfusd)) %>%
  select(year, currentadj, gfopebretired, gfopebactives, ercpenadj, health) %>%
  pivot_longer(-c(year, currentadj)) %>%
  mutate(share=value / currentadj,
         name=factor(name,
                     levels=c("health", "ercpenadj", "gfopebactives", "gfopebretired"),
                     labels=c("employee health", "pensions", "opeb-actives", "opeb-retirees"))) %>%
  arrange(name)

p <- pdata %>%
  ggplot(aes(year, share, color=name)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name=NULL) +
  scale_y_continuous(name="% share", labels=percent, breaks=seq(0, 1, .025), limits = c(0, NA)) +
  labs(caption="Source: California Department of Education SACS financial data.") + 
  ggtitle("SFUSD health, pension, and OPEB expenditures as % of current education expense",
          subtitle="General fund only. Current expenses adjusted to include OPEB payments. Current expenses and pension payments adjusted to remove state payments to TRS on behalf of districts.") +
  theme_bw() +
  theme(plot.caption = element_text(hjust = 0, face="italic")) +
  legend_notitle
p

ggsave(plot=p, filename=here::here("results", "benefit_shares.png"), width=10, height=6.5, units="in")
write_csv(pdata, here::here("results", "benefit_shares_data.csv"))

```

## SFUSD real per-pupil current educational spending on benefits and other items

```{r gdppi}
# isolate this so we don't keep rerunning it

# Gross domestic product (chain-type price index)
# FRED https://fred.stlouisfed.org/series/A191RG3A086NBEA
price <- fredr("A191RG3A086NBEA", frequency = "a")
gdppi <- price %>%
  rename(gdppi=value) %>%
  mutate(year=year(date),
         igdppi=gdppi[year==2020] / gdppi) %>%
  select(year, gdppi, igdppi)

```


```{r rxpp}
names(sacs_gfcurrent)
xpp <- sacs_gfcurrent %>%
  filter(eval(sfusd)) %>%
  left_join(leas %>% 
              filter(eval(sfusd)) %>%
              select(year, ccode, dcode, k12ada), 
            by = c("ccode", "dcode", "year")) %>%
  left_join(gdppi %>% select(year, igdppi), by="year") %>%
  mutate(retben=gfopebretired + ercpenadj,
         salaries=certsals + classsals) %>%  
  pivot_longer(-c(year, ccode, dcode, dname, k12ada, igdppi)) %>%
  mutate(xpp=value / k12ada,  # expenditures per pupil
         rxpp=xpp * igdppi)

```


### Plot over time
```{r rpp_plot, include=TRUE}
# names(sacs_gfcurrent)
capt <- "Note: retirement benefits include OPEB payments for retirees, and exclude state contributions to CalSTRS on behalf of districts"

p <- xpp %>%
  filter(name %in% c("service", "retben", "salaries", "health")) %>%
  ggplot(aes(year, rxpp, colour=name)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(name="2020 $ per pupil", breaks=seq(0, 10e3, 2e3), labels=comma, limits=c(0, NA)) +
  scale_x_continuous(name=NULL) +
  ggtitle("Expenditures per pupil, 2020 dollars",
          subtitle = "Salaries, services, retirement benefits (pension + OPEB), and employee health") +
  labs(caption=str_wrap(capt, 80)) + 
  theme_bw() +
  caption_left +
  legend_notitle
p

```

### Table of real per pupil general fund spending at key points in time
```{r include=TRUE}
# count(xpp, name)
# names <- c("currentadj", "health", "salaries", "gfopeb", "ercpenadj", "books")
tabdata <- xpp %>%
  select(year, name, rxpp) %>%
  filter(year %in% seq(2000, 2020, 5),
         name %in% names) %>%
  pivot_wider(names_from = name, values_from = rxpp, values_fill = 0) %>%
  mutate(other=currentadj - rowSums(across(-c(year, currentadj)))) %>%
  pivot_longer(-year) %>%
  pivot_wider(names_from = year, names_prefix = "y") %>%
  mutate(change=y2020 - y2015,
         pchange=change / y2020) %>%
  mutate(group=ifelse(name=="other", 2, 1)) %>%
  arrange(group, -y2020) %>%
  select(-group)

tabdata %>%
  gt() %>%
  tab_header(
      title = "Real per-pupil general fund expenditures in SFUSD",
      subtitle = "2020 dollars (GDP price index)"
    ) %>%
    fmt_number(
      columns = c(starts_with("y"), change),
      decimals = 0,
      suffixing = FALSE
    ) %>%
    fmt_percent(
      columns = "pchange",
      decimals = 1
    )

```


## General fund OPEB spending

```{r opebdf}
opebdf <- sacs_gfcurrent %>%
  select(year, ccode, dcode, dname, currentadj, gfopeb, gfopebretired, gfopebactives,
         o3701, o3702, o3751, o3752) %>%
  left_join(leas %>% select(year, ccode, dcode, k12ada), 
            by = c("year", "ccode", "dcode")) %>%
  # NOTE: using TOTAL opeb below, not just retired or actives
  mutate(share=gfopeb / currentadj,
         opebpp=gfopeb / k12ada,
         teacher=o3701 + o3751,
         classified=o3702 + o3752,
         teacherpp=teacher / k12ada,
         classifiedpp=classified / k12ada,
         retiredpp=gfopebretired / k12ada,
         activespp=gfopebactives / k12ada,
         sfusd=eval(sfusd))
# ns(sacs_gfcurrent)
```


A few quick exploratory graphs

```{r}
# find oddities
opebdf %>%
  filter(year==2020) %>%
  select(ccode, dcode, dname, k12ada, gfopebretired, gfopebactives, gfopeb, opebpp, share) %>%
  arrange(desc(gfopeb))


# drop ccode 19	dcode 40139	Pupil Transportation Co-Op JPA, which is 100%

# a lot of the oddities have k12ada <= 100
opebdf %>%
  filter(year==2020, k12ada > 0) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(desc(opebpp))

opebdf %>%
  filter(year==2020, k12ada >= 1000) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(gfopeb)

opebdf %>%
  filter(year==2020, k12ada >= 100) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(desc(opebpp))

opebdf %>%
  filter(year==2020) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, opebpp, share) %>%
  arrange(desc(k12ada))


drops <- expression((ccode==19 & dcode==40139))
opeb2 <- opebdf %>%
  filter(!eval(drops), k12ada >= 1000, gfopeb >= 0)

```


```{r opeb_share, include=TRUE}

opeb2 %>%
  filter(year==2020) %>%
  ggplot(aes(k12ada, share, colour=sfusd)) +
  geom_point() +
  scale_x_log10(labels=comma) +
  scale_y_continuous(labels=percent) +
  # scale_y_log10(labels=percent) +
  ggtitle("OPEB (retired + actives) as % of adjusted current expenditures, General Fund, 2020",
          subtitle="By district size (attendance), log10 scale") +
  labs(caption="Districts with at least 1,000 students and nonnegative opeb. Several outliers excluded.") +
  caption_left
   

```


```{r opeb_ada, include=TRUE}
# relative to attendance
opeb2 %>%
  filter(year==2020) %>%
  ggplot(aes(k12ada, opebpp, colour=sfusd)) +
  geom_point() +
  scale_x_log10(labels=comma) +
  # scale_y_log10() + # labels=comma
  scale_y_continuous(limits=c(0, NA)) +
  ggtitle("OPEB expenditures (retired + actives) per pupil, General Fund, 2020",
          subtitle="By district size (attendance), log10 scale") +
  labs(caption="Districts with at least 1,000 students and nonnegative opeb. Several outliers excluded.") +
  caption_left



```
## General fund OPEB spending by largest districts (by attendance)

### Actives and retired
```{r largest_districts, include=TRUE}
year <- 2020

tabdata <- opeb2 %>%
  filter(year==!!year) %>%
  arrange(desc(k12ada)) %>%
  filter(row_number() <= 10) %>%
  mutate(across(starts_with("gf"), ~.x / 1e6)) %>%
  select(ccode, dcode, dname, k12ada, gfopebretired, gfopebactives, gfopeb, opebpp)

tabdata %>%
  gt() %>%
  tab_header(
      title = paste0("General fund opeb-related expenditures, ", year, ", largest districts by enrollment"),
      subtitle = "GF expenditures in $ millions, per pupil in $"
    ) %>%
    fmt_number(
      columns = k12ada,
      decimals = 0,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = starts_with("gf"),
      decimals = 2,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = opebpp,
      decimals = 0,
      suffixing = FALSE
    )
  

```



### Teachers and classified
```{r largest_districts_etype, include=TRUE}
year <- 2020

tabdata <- opeb2 %>%
  filter(year==!!year) %>%
  arrange(desc(k12ada)) %>%
  filter(row_number() <= 10) %>%
  mutate(across(starts_with("gf"), ~.x / 1e6)) %>%
  select(ccode, dcode, dname, k12ada, gfopeb, teacherpp, classifiedpp, opebpp)

tabdata %>%
  gt() %>%
  tab_header(
      title = paste0("General fund opeb-related expenditures, ", year, ", largest districts by enrollment"),
      subtitle = "GF expenditures in $ millions, per pupil in $"
    ) %>%
    fmt_number(
      columns = k12ada,
      decimals = 0,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = starts_with("gf"),
      decimals = 2,
      suffixing = FALSE
    ) %>%
    fmt_number(
      columns = c(teacherpp, classifiedpp, opebpp),
      decimals = 0,
      suffixing = FALSE
    )
  

```


### Large districts' general fund OPEB spending over time

```{r fig.height=8, fig.width=8, include=TRUE}
# get large districts
n <- 25

large <- opeb2 %>%
  filter(year==2020) %>%
  arrange(desc(k12ada)) %>%
  filter(row_number() <= n) %>%
  arrange(desc(opebpp)) %>%
  mutate(sort=row_number()) %>%
  select(year, ccode, dcode, dname, k12ada, opebpp, sort)

# get plot data
pdata <- large %>%
  select(ccode, dcode, dname) %>%  # use the 2020 name as they can change over time
  left_join(opeb2 %>%
              select(year, ccode, dcode, activespp, retiredpp, opebpp),
            by = c("ccode", "dcode")) %>%
  pivot_longer(cols=(ends_with("pp"))) %>%
  mutate(dname2=factor(dname, levels=large$dname, labels=large$dname))

p <- pdata %>%
  filter(name=="opebpp") %>%
  arrange(dname2) %>%
  ggplot(aes(year, value)) +
  geom_line(colour="blue") +
  geom_point(colour="blue") +
  theme_bw() +
  facet_wrap(~dname2, ncol=5) +
  ggtitle(label="General Fund OPEB expenditures per pupil over time. CAUTION: Nominal.",
          subtitle="25 largest California school districts, by attendance. Districts ordered by 2020 per-pupil OPEB spending.") +
  scale_y_continuous(name="$ per pupil", labels=comma) +
  scale_x_continuous(name=NULL) +
  labs(caption="NOTE: Includes payments for retirees plus any trust contributions for actives") +
  caption_left
  
p  


```



```{r doc_opeb}

# documentation on selected sacs codes ------------------------------------
#.. 3101–3102 State Teachers’ Retirement System ----
# State Teachers’ Retirement System. Record expenditures to provide personnel
# with retirement benefits under the State Teachers’ Retirement System (STRS).
# This excludes employee contributions. Object 3101 is certificated personnel in
# STRS; Object 3102 includes those individuals who hold classified positions but
# are enrolled in STRS.

#.. 3201–3202 Public Employees’ Retirement System ----
# Public Employees’ Retirement System. Record expenditures to provide personnel
# with retirement benefits under the Public Employees’ Retirement System (PERS).
# This excludes employee contributions, although it does include the employer’s
# payment of an employee’s contribution. Object 3201 indicates those employees
# in certificated positions and enrolled in PERS; Object 3202 indicates
# employees in classified positions and enrolled in PERS.

#.. 3401–3402 Health and Welfare Benefits ----
# Health and Welfare Benefits. Record expenditures made to provide personnel
# with health and welfare insurance benefits. This excludes employee
# contributions but includes health and welfare benefit premiums paid to a
# self-insurance fund. Object 3401 indicates that the benefits cover
# certificated positions; Object 3402 indicates that the benefits cover
# classified positions.


#.. 3701 OPEB, Allocated, certificated positions ----
# Expenditures (1) for retirees and other former employees for current-year
# postemployment benefits other than pensions (OPEB) financed on a pay-as-you-go
# basis; or (2) for the amounts paid to an OPEB plan (administered through a
# qualifying trust) in excess of the current-year actuarially determined service
# cost. A qualifying trust is a trust or an equivalent arrangement that meets
# the criteria in paragraph 4 of GASB Statement 75. Do not include expenditures
# for service costs for active employees; these must be direct-charged using
# objects 3751–3752. Expenditures in objects 3701–3702 must be allocated to all
# activities in proportion to total salaries or total full-time equivalents
# (FTEs) in those activities. Object 3701 relates to certificated positions;
# Object 3702 relates to classified positions.

#.. 3702 OPEB, Allocated, classified positions ----
# same text

#.. 3751 OPEB, Active Employees, certificated positions ----
# Expenditures for the amounts paid to a OPEB plan (administered through a
# qualifying trust) up to the current-year actuarially determined service costs
# for OPEB-eligible active employees. A qualifying trust is a trust or an
# equivalent arrangement that meets the criteria in paragraph 4 of GASB
# Statement 75. Do not include expenditures for retirees and other former
# employees; these must be allocated using objects 3701–3702. Expenditures in
# objects 3751–3752 must be direct-charged on a per-eligible-FTE basis to the
# same resource, goal, and function as the OPEB-eligible active employee’s
# salary. Object 3751 relates to certificated positions; Object 3752 relates to
# classified positions.

#.. 3752 OPEB, Active Employees, classified positions----
# same text

#.. 9664 Total/Net OPEB Liability ----
# The total OPEB liability is the portion of the actuarial present value of
# projected benefit payments that is attributed to past periods of employee
# service, measured in conformity with the requirements of GASB Statement 75.
# For a defined benefit OPEB plan that is not administered through a trust that
# meets the criteria in paragraph 4 of GASB 75 (specified criteria), the total
# OPEB liability is reported. For a defined benefit OPEB plan that is
# administered through a trust that meets the specified criteria, a net OPEB
# liability (that is, the total OPEB liability minus the OPEB plan’s fiduciary
# net position) is reported. The total or net OPEB liability is reported only in
# the LEA’s accrual-basis financial statements.

# I don't bother to include 9664 because almost no districts report it.

```



# J-90 OPEB data

```{r}
opeb_j90 <- readRDS(paste0(dj90_all, "opeb.rds"))

```

```{r}
opeb_j90 %>%
  filter(eval(sfusd)) %>%
  filter(plantype=="health") %>%
  filter(year==2020) %>%
  mutate(erpct=totercost / sum(totercost),
         lbl=ifelse(erpct > .05, round(erpct, 2), "")) %>%
  ggplot(aes(x=planeecost, y=opebfte, size=erpct, colour=coverage, label=lbl)) +
  geom_point() +
  geom_text(nudge_x = 750, size=3) +
  scale_y_continuous("# of participants", labels = scales::comma) +
  scale_x_continuous("annual cost to the participant", labels=scales::comma) +
  ggtitle("SFUSD retired OPEB participants and per-retiree plan costs in 2020")
```
